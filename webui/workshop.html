<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Zez's Workshop UI Recreation</title>

    <script src="libs/vue.min.js"></script>
    <script src="libs/vue-select.min.js"></script>
    <script src="libs/popper.min.js"></script>
    <script src="libs/toastify.js"></script>
    <link rel="stylesheet" href="libs/toastify.css">
    <link rel="stylesheet" href="libs/vue-select.min.css">
    <script src="../VS Code Extension/overpy.js"></script>
    <link rel="icon" type="image/png" href="img/favicon.png" />

    <style>
        :root {
            --rule-color: white;
            --rule-color-muted: rgb(141, 141, 141);
            --action-color: rgb(26, 174, 43);
            --condition-color: rgb(197, 161, 16);
            --action-color-muted: rgb(25, 111, 46);
            --condition-color-muted: rgb(104, 85, 14);
            --no-action-condition-color: rgb(147, 142, 141);
            --value-bg: rgb(0, 0, 0, 0.7);
            --separator-bar-color: rgba(62, 69, 81, 0.7);
            --label-background-color: rgba(50, 66, 96, 0.7);
            --dropdown-color: rgba(32, 82, 126, 0.7);
            --dropdown-bg-color: rgb(40, 54, 78);
            --dropdown-bg-color-hover: rgb(27, 116, 187);
            --dropdown-value-bg-hover: rgb(38, 141, 186);
            --action-hover-color: white;
            --edit-background-color: rgb(34, 45, 65);
            --edit-buttons-bg-color: rgba(34, 32, 35, 0.85);
            --background-dim: rgba(0, 0, 0, 0.9);
            --cancel-bg-color: rgb(53, 162, 231);
            --ok-bg-color: rgb(223, 153, 49);
            --reset-to-defaults-bg-color: rgb(27, 116, 187);
            --text-color: rgb(199, 212, 223);
            --text-field-bg: rgb(206, 206, 207);
            --text-field-bg-focused: white;
            --text-field-color: black;
            --checkbox-bg: rgb(167, 170, 167);
            --checkbox-border: rgb(19, 43, 67);
            --collapse-line-color: rgb(26, 69, 104);
            --comment-color: rgb(162, 165, 170);
            --title-color: rgb(243, 243, 243);
            --delete-title-background: rgb(155, 6, 19);
            --variable-global-player-title: rgb(146, 153, 163);
            --title-background: rgb(55, 71, 107);
            --card-background: rgb(39, 50, 72);
            --description-color: rgb(248, 158, 27);
            --window-separator-color: rgb(80, 91, 113);
            --subtitle-color: rgb(185, 192, 208);
            --indent-bar-color: rgb(146, 151, 169);
            --array-button-border-color: rgb(156, 163, 176);
            --number-input-focused-border: rgb(56, 119, 177);
            --number-input-focused-bg: rgb(108, 140, 164);

            --toast-background: /*#d0d0d0*/ rgba(255, 255, 255, 0.8);
            --toast-text: black;
            --toast-error: rgb(194, 0, 13);
            --toast-warning: rgb(194, 171, 0);
            --toast-info: rgb(0, 100, 194);

            --syntax-coloration-variable-and-num: rgb(208, 208, 208);
            --syntax-coloration-value: rgb(176, 206, 247);
            --syntax-coloration-action-and-operator: rgb(237, 213, 140);
            --syntax-coloration-string: rgb(80, 113, 158);

            --label-font-size: 20px;
            --dropdown-font-size: 22px;

            --vs-dropdown-bg: var(--dropdown-bg-color);
            --vs-dropdown-color: var(--text-color);
            --vs-dropdown-option-color: var(--text-color);
            --vs-dropdown-option--active-bg: var(--dropdown-value-bg-hover);
            --vs-dropdown-option--active-color: var(--text-color);
            --vs-font-size: 22px;

            --vs-actions-padding: 0px 12px;
            --vs-search-input-color: var(--text-color);
            --vs-search-input-placeholder-color: var(--text-color);
            --vs-search-input-bg: var(--dropdown-color);
            --vs-selected-bg: var(--dropdown-bg-color);
            --vs-selected-color: var(--text-color);
            --vs-controls-color: var(--text-color);
            --vs-border-radius: 0px;
            --vs-border-width: 0px;
        }

        @font-face {
            font-family: "FuturaNo2D";
            src: url("fonts/futura_no2_d_demi_bold.ttf");
        }

        @font-face {
            font-family: "BigNoodle";
            src: url("fonts/big_noodle_too.ttf");
        }

        @font-face {
            font-family: "BlizzardGlobal";
            src: url("fonts/blizzard_global.ttf");
        }

        .font-blizzglobal {
            font-family: "BlizzardGlobal";
        }
        .font-futurano2d {
            font-family: "FuturaNo2D", "BlizzardGlobal";
        }
        .font-bignoodle {
            font-family: "BigNoodle", "BlizzardGlobal";
            font-style: italic;
        }

        * {
            box-sizing: border-box;
        }

        body, textarea {
            background-color: #222222;
            scrollbar-color: #CCCCCC #222222;
            text-transform: uppercase;
        }

        a {
            color: lightblue;
        }

        body {
            margin: 0px;
        }

        #app-wrapper-wrapper {

            background-size: cover;
        }

        #app-wrapper {
            backdrop-filter: blur(10px) brightness(30%);
            display: flex;
            justify-content: center;
        }

        #app {
            max-width: 1580px;
            width: 100%;
            height: 100vh;
            display: grid;
            padding-bottom: 30px;
            align-content: baseline;
            margin-left: 150px;
            margin-right: 150px;
        }

        #workshop-title {
            font-size: 48px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding-bottom: 20px;
            padding-top: 10px;
        }

        .rule {
            padding-bottom: 7px;
            padding-top: 7px;
            display: flex;
        }

        .rule-collapse-bar {
            padding-right: 8px;
            display: flex;
            flex-flow: column;
            align-items: center;
        }

        .rule-collapse-button, .rule-expand-button {
            margin-top: 3px;
            margin-left: 1px;
        }

        .rule-collapse-line {
            flex: 1;
            width: 3px;
            background-color: var(--collapse-line-color);
        }

        .rule-header-and-content {
            width: 100%;
        }

        .rule-header {
            display: flex;
            align-items: center;
        }

        .rule-title {
            resize: none;
            height: 43px;
            border: 1px solid var(--text-field-bg-focused);
            border-radius: 6px;
            padding-left: 12px;
            white-space: pre;
            width: 100%;
            overflow: hidden;
            font-size: 21px;
            background-color: var(--text-field-bg);
            color: var(--text-field-color);
            margin-right: 9px;
        }

        .rule-title:hover, .rule-title:focus {
            background-color: var(--text-field-bg-focused);
        }

        .rule-title:focus {
            outline: var(--text-field-bg-focused) solid 2px;
        }

        .rule-content {
            padding-left: 83px;
            width: 100%;
            padding-top: 10px;
            padding-right: 59px;
            padding-bottom: 67px;
        }

        .rule-event {
            width: auto;
            margin-bottom: 7px;
            padding-left: 2px;
            display: flex;
        }

        .rule-event-name {
            background-color: var(--label-background-color);
            display: inline-block;
            display: flex;
            align-items: center;
            width: 100%;
            margin-right: 7px;
            padding-left: 20px;
            height: 40px;
            font-size: var(--label-font-size);
            color: var(--text-color);
        }

        .rule-event-value {
            display: inline-block;
            min-width: 553px;
            font-size: var(--dropdown-font-size);
        }

        input[type="checkbox"] {
            width: 30px;
            height: 30px;
            outline: var(--checkbox-border) solid 3px;
        }

        #workshop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--separator-bar-color);
            padding-bottom: 10px;
            margin-bottom: 7px;
        }

        #rules {
            overflow: auto;
            padding-right: 20px;
        }

        #rules-title {
            color: var(--rule-color);
            font-size: 29px;
            padding-right: 13px;
            margin-right: 2px;
        }

        #rules-nb {
            color: var(--rule-color-muted);
            font-size: 22px;
            padding-right: 7px;
        }

        .button-header {
            margin-left: 5px;
        }

        .img-button:hover {
            outline: white solid 1px;
            z-index: 1000;
            position: relative;
        }

        .button-delete.button-header {
            margin-right: 70px;
        }
        
        #button-separator {
            border-left: 3px solid var(--separator-bar-color);
            height: 50px;
            padding-left: 10px;
            margin-left: 15px;
        }

        #buttons-move-up-down {
            display: grid;
        }

        .button-header #button-move-up {
            margin-bottom: 2px;
        }

        #workshop-header-left {
            display: flex;
            align-items: center;
        }

        #workshop-header-right {
            display: flex;
            align-items: center;
        }

        .v-select {
            height: 100%;
            display: grid;
        }

        .vs__selected-options {
            padding-left: 12px;
        }

        .vs__selected {
            margin: 0px;
            padding: 0px;
            height: 100%;
        }

        .vs__search, vs__search:focus {
            padding: 0px !important;
            margin: 0px !important;
            font-family: inherit;
            font-size: 22px;
        }

        .vs__dropdown-menu {
            font-size: 18px;
        }

        .vs__dropdown-toggle {
            padding-bottom: 0px;
        }

        .vs__dropdown-toggle:hover {
            background-color: var(--dropdown-bg-color-hover);
        }

        .conditions-header, .actions-header {
            text-transform: uppercase;
            border-bottom: 3px solid var(--separator-bar-color);
            font-size: var(--dropdown-font-size);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 9px;
            margin-bottom: 8px;
        }

        .conditions-header {
            color: var(--condition-color);
        }

        .conditions-nb {
            color: var(--condition-color-muted);
        }

        .actions-header {
            color: var(--action-color);
        }

        .actions-nb {
            color: var(--action-color-muted);
        }

        .conditions-and-actions {
            display: flex;
            padding-top: 4px;
        }

        .conditions, .actions {

            width: 50%;
            display: inline-block;
        }

        .actions {
            padding-left: 20px;
        }
        .conditions {
            padding-right: 20px;
        }
        
        .action {
            display: flex;
            flex-wrap: wrap;
        }

        .conditions-buttons, .actions-buttons {
            display: flex;
        }

        .button-action-condition {
            margin-left: 5px;
            height: 35px;
            width: 35px;
        }

        .button-delete.button-action-condition {
            margin-right: 35px;
        }

        .button-action-condition #button-move-up {
            margin-bottom: 1.5px;
        }

        .button-action-condition #button-move-up, .button-action-condition #button-move-down {
            height: 16.5px;
            width: 35px;
        }

        .no-values-msg {
            text-transform: uppercase;
            text-align: center;
            padding-top: 10px;
            font-size: 22px;
            color: var(--no-action-condition-color);
        }

        #app > .no-values-msg {
            font-size: 45px;
            height: calc(100vh - 178px); /*how the fuck do I center this shit*/
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            align-content: center;
            justify-content: center;
            padding-bottom: 19vh;
            row-gap: 20px;
        }

        #no-rules {
            width: 100%;
        }

        #no-rules-help {
            width: 100%;
            font-size: 23px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #no-rules-help img {
            width: 26px;
            height: 26px;
            margin: 10px;
        }

        .code-display-wrapper {
            width: 100%;
            background-color: var(--value-bg);
            display: inline-block;
            margin-top: 3px;
            margin-bottom: 3px;
            margin-right: 4px;
            border: 2px solid transparent;
            font-size: 17px;
        }

        .disabled {
            filter: brightness(35%);
        }

        .code-display-wrapper:hover {
            border-color: var(--action-hover-color);
        }

        .code-display {
            word-break: break-word;
            padding: 9px;
            text-transform: none;
            color: var(--syntax-coloration-action-and-operator);
        }

        .code-operator {
            color: var(--syntax-coloration-action-and-operator);
        }

        .code-var {
            color: var(--syntax-coloration-variable-and-num);
        }

        .code-value {
            color: var(--syntax-coloration-value);
        }

        .code-string {
            color: var(--syntax-coloration-string);
        }

        .action .code-display {
            border-left: 3px solid var(--action-color);
        }

        .condition .code-display {
            border-left: 3px solid var(--condition-color);
        }

        .comment {
            display:block;
            width: 100%;
            padding-top: 15px;
            padding-left: 15px;
            padding-right: 56px;
            white-space: pre-wrap;
            color: var(--comment-color);
            text-transform: none;
            font-size: 15px;
        }


        .code-and-checkbox {
            display: flex;
            align-items: center;
            width: 100%;
        }

        #ast-edit, #variables-edit-screen, #subroutines-edit-screen, #extensions-edit-screen, #metrics-screen, #info-screen, #settings-screen, #import-screen, #settings-screen {
            z-index: 9999;
            position: fixed;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            background-color: var(--background-dim);
        }

        #edit-title, .variables-edit-title {
            text-align: center;
            color: var(--title-color);
            width: 100%;
            font-size: 45px;
            margin-bottom: 10px;
        }

        #edit-comment-wrapper {
            border-bottom: 3px solid var(--window-separator-color);
            margin-bottom: 9px;
            padding-bottom: 5px;
            width: 100%;
            padding-left: 4px;
            padding-right: 4px;

        }

        textarea {
            resize: none;
            height: 33px;
            border: 1px solid var(--text-field-bg-focused);
            border-radius: 6px;
            padding-left: 10px;
            white-space: pre-wrap;
            width: 100%;
            overflow: hidden;
            font-size: 21px;
            background-color: var(--text-field-bg);
            color: var(--text-field-color);
            text-transform: none;
        }

        .rule-title:hover, .rule-title:focus, textarea:focus {
            background-color: var(--text-field-bg-focused);
        }

        .rule-title:focus, textarea:focus {
            outline: var(--text-field-bg-focused) solid 2px;
        }

        #edit-background, .variables-background {
            padding-top: 50px;
            margin-top: 50px;
            margin-bottom: 50px;
            max-height: 100%;
        }

        #edit-background, .variables-background, .window-background {
            display: grid;
            grid-template-rows: auto;
            width: 100%;
            background-color: var(--edit-background-color);
            justify-items: center;
        }
        #info-screen .window-background {
            max-height: 100%;
            margin-top: 50px;
            margin-bottom: 50px;
        }

        .window-background {
            justify-items: center;
        }

        #extensions-edit-screen .window-background {
            height: calc(100% - 50px);
        }

        #edit-content {
            max-height: calc(100vh - 400px);
            overflow: auto;
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 50px;
            max-width: 1490px;
            padding-right: 2px;
            width: 100%;
        }

        .argument-value-wrapper-wrapper {
            display: flex;
            width: 100%;
            flex-wrap: wrap;
        }

        .argument-value-wrapper {
            display: flex;
            min-height: 39px;
            width: 100%;
            margin-bottom: 7px;
            font-size: 18px;
        }

        .argument {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: var(--label-background-color);
            padding-left: 21px;
            padding-right: 10px;
            margin-right: 7px;
            color: var(--text-color);
            height: 100%;
        }

        .argument.argument-number {
            margin-right: 0px;
        }

        .value {
            min-width: 600px;
            display: flex;
            height: 100%;
            font-size: 22px;
        }

        .value-dropdown {
            height: 100%;
            width: 100%;
        }

        .number-input {
            background-color: var(--label-background-color);
            width: 100%
        }

        input[type="number"] {
            background-color: transparent;
            padding-left: 9px;
            color: var(--title-color);
            font-size: inherit;
            border: none;
            height: 100%;
            width: 100px;
            z-index: 999999999;
            -moz-appearance: textfield;
        }

        input[type="number"]:hover {
            outline: white 1px solid;
        }

        input[type="number"]:focus {
            outline: var(--number-input-focused-border) 1px solid;
            background-color: var(--number-input-focused-bg);
            color: black;
        }

        .value-string {
            width: 100%;
            padding-left: 5px;
            padding-right: 7px;
            display: flex;
            align-items: center;
        }

        .array-img-button {
            border: 4px solid var(--array-button-border-color);
            border-radius: 4px;
        }

        .array-img-button:hover {
            border-color: white;
        }

        .array-add, .array-remove, .array-up-down {
            margin-right: 4px;
        }

        .array-up-down {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .indent-marker {
            min-width: 2px;
            background-color: var(--indent-bar-color);
            margin-left: 15px;
            margin-right: 14px;
            margin-top: -4px;
            margin-bottom: -4px;
            height: auto;
        }

        .edit-buttons {
            width: 100%;
            text-align: center;
            height: 71px;
            background-color: var(--edit-buttons-bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            column-gap: 5px;
        }

        .cancel-button {
            background-color: var(--cancel-bg-color);
            width: 130px;
            height: 55px;
            font-size: 27px;
        }

        .ok-button {
            background-color: var(--ok-bg-color);
            width: 145px;
            height: 55px;
            font-size: 30px;
        }

        .cancel-button, .ok-button {
            color: var(--title-color);
            text-transform: uppercase;
            border-radius: 2px;
            border: 1px solid transparent;
        }

        button:hover {
            border-color: white;
        }

        .no-uppercase {
            text-transform: none;
        }
        
        #delete-confirmation {
            clip-path: circle(0);
            z-index: 99999;
            position: fixed;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            align-content: center;
            flex-wrap: wrap;
            background-color: var(--background-dim);
            background-image: url("img/delete-background-2.png");
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-position: center;
        }
        /*cannot use display:none because else the image won't be loaded on start*/
        #delete-confirmation.shown {
            clip-path: none;
        }

        #delete-title {
            text-align: center;
            color: var(--title-color);
            /*background-color: var(--delete-title-background);*/
            text-shadow: 0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red,0 0 10px red;
            font-size: 45px;
            padding-bottom: 70px;
            padding-top: 30px;
            padding-right: 5px;
            width: 100%;
        }

        .variables-background {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        #variables-edit-wrapper {
            padding-left: 200px;
            padding-right: 200px;
            padding-top: 35px;
            width: 100%;
            display: flex;
            justify-content: center;
            column-gap: 35px;
            height: calc(100% - 250px);
        }

        .variables-edit {
            width: 100%;
            display: grid;
            grid-template-rows: auto auto;
            max-width: 750px;
        }

        .variables-edit-subtitle {
            color: var(--variable-global-player-title);
            text-align: center;
            font-size: 30px;
        }

        .variables-edit-fields {
            overflow: auto;
            display: grid;
            row-gap: 7px;
            margin-top: 6px;
            max-height: calc(100vh - 600px);
            min-height: 50px;
        }

        .variables-edit-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .variables-edit-nb {
            color: var(--text-color);
            font-size: 20px;
            width: 50px;
            text-align: center;
        }

        .variables-edit-field {
            width: 100%;
            height: 40px;
            border: 1px solid var(--text-field-bg-focused);
            border-radius: 6px;
            padding-left: 12px;
            white-space: pre;
            overflow: hidden;
            font-size: 21px;
            background-color: var(--text-field-bg);
            color: var(--text-field-color);
            margin-right: 7px;
        }
        .variables-edit-field:hover, .variables-edit-field:focus {
            background-color: var(--text-field-bg-focused);
        }

        .variables-edit-field:focus {
            outline: var(--text-field-bg-focused) solid 2px;
        }

        .reset-to-defaults {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            padding-right: 200px;
            padding-top: 50px;
            padding-bottom: 20px;
        }

        .reset-to-defaults-button {
            color: var(--title-color);
            background-color: var(--reset-to-defaults-bg-color);
            font-size: 25px;
            width: 250px;
            height: 55px;
            text-transform: uppercase;
            border-radius: 2px;
            border: 1px solid transparent;
        }

        .window-edit-title {
            text-align: center;
            color: var(--title-color);
            width: 100%;
            font-size: 45px;
            background-color: var(--title-background);
            height: 91px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cards {
            display: flex;
            column-gap: 18px;
            padding-top: 23px;
            justify-content: center;
            padding-bottom: 23px;
        }

        .card {
            width: 280px;
            height: 248px;
            text-align: center;
            background-color: var(--card-background);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-title {
            height: 94px;
            color: var(--subtitle-color);
            font-size: 19px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-value {
            height: 61px;
            border-bottom: 3px solid var(--window-separator-color);
            margin-left: 29px;
            margin-right: 29px;
            color: var(--title-color);
            font-size: 30px;
            width: 100%;
        }

        .card-description {
            padding-top: 20px;
            color: var(--description-color);
            text-transform: none;
            padding-left: 27px;
            padding-right: 27px;
            font-size: 11pt;
            height: 100%;
        }

        #extensions {
            max-width: 1130px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            row-gap: 27px;
            overflow: auto;
            margin-top: 24px;
            min-height: 50px;
        }

        .extension {
            width: 100%;
            display: flex;
            align-items: center;
            text-align: center;

        }

        .extension-title {
            width: 280px;
            color: var(--title-color);
            text-transform: none;
            font-size: 19px;
        }

        .extension-description {
            width: 500px;
            color: var(--description-color);
            text-transform: none;
            font-size: 11pt;
        }

        .extension-points {
            width: 135px;
            color: var(--title-color);
            font-size: 19px;
        }

        .extension-checkbox {
            width: 135px;
        }

        #info {
            max-width: 800px;
            width: 100%;
            text-align: center;
            color: var(--text-color);
            text-transform: none;
            font-size: 16pt;
            display: flex;
            flex-wrap: wrap;
            overflow: auto;
            max-height: calc(100vh - 300px);
        }

        #info p {
            width: 100%;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .setting {
            display: flex;
            column-gap: 10px;
            padding-bottom: 5px;
            padding-top: 5px;
            width: 100%;
        }

        .setting-name {
            background-color: var(--label-background-color);
            width: 70%;
            text-align: left;
            padding-left: 5px;
        }

        .setting-value {
            width: 100%;
        }

        #decompile-text {
            min-height: 400px;
            overflow: auto;
        }

        .toastify {
            background: none;
            box-shadow: none;
            background-color: var(--toast-background);
            color: var(--toast-text);
            text-transform: none;
            border: none;
            border-radius: 0;
            width: 435px;
            padding: 5px 10px 5px 0px;
            display: flex;
            align-items: center;
            min-height: 46px;
            cursor: auto;
        }

        .toastify::before {
            display: flex;
            margin-right: 10px;
            margin-top: -5px;
            margin-bottom: -5px;
            align-self: stretch;
            content: "";
            min-width: 43px;
            background-position: center;
            background-repeat: no-repeat;
        }

        .toastify.error::before {
            background-image: url("img/error.png");
            background-color: var(--toast-error);
        }
        .toastify.info::before {
            background-image: url("img/success.png");
            background-color: var(--toast-info);
        }
        .toastify.warning::before {
            background-image: url("img/warning.png");
            background-color: var(--toast-warning);
        }

		#settings-wrapper {
            max-width: 1200px;
            width: 100%;
            text-align: center;
            color: var(--text-color);
            text-transform: none;
            font-size: 16pt;
            display: flex;
            flex-wrap: wrap;
            overflow: auto;
            max-height: calc(100vh - 300px);
			text-transform: uppercase;
			padding: 5px;
			row-gap: 5px;
		}

		.cgs-content {
			width: 100%;
            display: flex;
            flex-wrap: wrap;
			margin-top: 5px;
		}

		.cgs-content .cgs-content, .cgs-values {
			padding-left: 42px;
		}

		.cgs-title-wrapper {
			width: 100%;
			display: flex;
            flex-wrap: wrap;
			align-items: center;
			column-gap: 5px;
		}

		.cgs-values {
			width: 100%;
            display: flex;
            flex-wrap: wrap;
			row-gap: 5px;
			padding-top: 5px;
		}

		.cgs-setting-name-value {
			width: 100%;
            display: flex;
			column-gap: 5px;
			align-items: center;
		}

		.cgs-setting-name {
			width: 100%;
			background-color: var(--label-background-color);
			justify-content: end;
            padding-left: 10px;
			padding-right: 10px;
			height: 100%;
			display: flex;
			align-items: center;
		}

		.cgs-setting-value {
			width: 100%;
			display: flex;
			justify-content: center;
		}

		.cgs-setting-value .v-select {
			width: 100%;
		}
		
		.cgs-setting-value input[type="checkbox"] {
			width: 100%;
		}

		.cgs-setting-value input[type="number"] {
			text-align: center;
			width: 130px;
			padding: 0px;
		}
		.cgs-setting-value input[type="range"] {
			width: 100%;
		}

    </style>
</head>
<body class="font-futurano2d">
    <div id="app-wrapper-wrapper" :style="{'background-image': 'url(&quot;img/backgrounds/'+background+'&quot;)'}">
    <div id="app-wrapper">
    <div id="app">
        <div id="workshop-title" class="font-bignoodle">Zez's workshop UI recreation [BETA]</div>
        <div id="workshop-header">
            <div id="workshop-header-left">
                <div id="rules-title">{{ translate("rules", workshopUiKw) }}</div>
                <div id="rules-nb">({{ rules.length || 0}})</div>
                <img id="button-info" class="img-button button-header" src="img/info.png" v-on:click="displayInfo = true"/>
                <img id="button-metrics" class="img-button button-header" src="img/metrics.png" v-on:click="displayMetricsScreen()"/>
                <img id="button-import" class="img-button button-header" src="img/import.png" v-on:click="displayImport = true"/>
                <img id="button-settings" class="img-button button-header" src="img/settings.png" v-on:click="editCustomGameSettings()"/>
                <img id="button-save" class="img-button button-header" src="img/save.png" v-on:click="saveGamemode()"/>
            </div>
            <div id="workshop-header-right">
                <img id="button-extensions" class="img-button button-header" src="img/extensions.png" v-on:click="editExtensions()"/>
                <img id="button-var-names" class="img-button button-header" src="img/var_names.png" v-on:click="editVariables()"/>
                <img id="button-subroutine-names" class="img-button button-header" src="img/subroutine_names.png" v-on:click="editSubroutines()"/>
                <div id="button-separator"></div>
                <template v-if="rules.some(x => x.isSelected)">
                    <img class="img-button button-header button-delete" src="img/delete.png" v-on:click="deleteSelectedRules()"/>
                    <div id="buttons-move-up-down" class="button-header">
                        <img id="button-move-up" class="img-button" src="img/move_up.png" v-on:click="moveSelectedRules(true)"/>
                        <img id="button-move-down" class="img-button" src="img/move_down.png" v-on:click="moveSelectedRules(false)"/>
                    </div>
                    <img id="button-toggle" class="img-button button-header" src="img/toggle.png" v-on:click="toggleSelectedRules()"/>
                    <img id="button-copy" class="img-button button-header" src="img/copy.png" v-on:click="copySelectedRules()"/>
                </template>
                <img v-if="clipboard?.type === 'rules'" id="button-paste" class="img-button button-header" src="img/paste.png" v-on:click="pasteRules()"/>
                <img id="button-select-all" class="img-button button-header" src="img/select_all.png" v-on:click="selectAllRules()"/>
                <img id="button-add" class="img-button button-header" src="img/add.png" v-on:click="addRule()"/>
            </div>
        </div>
        <div v-if="rules.length === 0" class="no-values-msg font-blizzglobal"><div id="no-rules">{{ translate("noRules", workshopUiKw) }}</div><div id="no-rules-help" class="font-futurano2d">Press the <img id="button-import" src="img/import.png"/> button to import an existing gamemode</div></div>
        <div v-else id="rules">
            <div class="rule" v-for="(rule, ruleIdx) in rules">
                <div class="rule-collapse-bar">
                    <template v-if="rule.isCollapsed">
                        <img class="img-button rule-expand-button" src="img/expand_rule.png" v-on:click="rule.isCollapsed=false"/>
                    </template>
                    <template v-else>
                        <img class="img-button rule-collapse-button" src="img/collapse_rule.png" v-on:click="rule.isCollapsed=true"/>
                        <div class="rule-collapse-line"></div>
                    </template>
                </div>
                <div class="rule-header-and-content">

                    <div class="rule-header">
                        <input type="text" class="rule-title" :class="{'disabled': rule.ruleAttributes.isDisabled}" v-model="rule.ruleAttributes.name">
                        <input type="checkbox" class="checkbox" v-model="rule.isSelected">
                    </div>
                    <div class="rule-content" v-if="!rule.isCollapsed">
                        <div class="rule-event">
                            <div class="rule-event-name">{{ translate("event", ruleAttributesDisplayNamesKw) }}</div>
                            <div class="rule-event-value">
                                <v-select append-to-body :calculate-position="calculateDropdownPosition"  :clearable="false" :options="getDropdownOptionsForType('event')" :reduce="x => x.code" v-model="rule.ruleAttributes.event" v-on:input="rebuildRuleAttributes(rule)">
                                </v-select>
                            </div>
                        </div>
                        <div class="rule-event" v-if="rule.ruleAttributes.eventPlayer">
                            <div class="rule-event-name">{{ translate("eventPlayer", ruleAttributesDisplayNamesKw) }}</div>
                            <div class="rule-event-value"><v-select append-to-body :calculate-position="calculateDropdownPosition"  :clearable="false" :options="getDropdownOptionsForType('eventPlayer')" :reduce="x => x.code" v-model="rule.ruleAttributes.eventPlayer"></v-select></div>
                        </div>
                        <div class="rule-event" v-if="rule.ruleAttributes.eventTeam">
                            <div class="rule-event-name">{{ translate("eventTeam", ruleAttributesDisplayNamesKw) }}</div>
                            <div class="rule-event-value"><v-select append-to-body :calculate-position="calculateDropdownPosition"  :clearable="false" :options="getDropdownOptionsForType('eventTeam')" :reduce="x => x.code" v-model="rule.ruleAttributes.eventTeam"></v-select></div>
                        </div>
                        <div class="rule-event" v-if="rule.ruleAttributes.subroutineName">
                            <div class="rule-event-name">{{ translate("subroutineName", ruleAttributesDisplayNamesKw) }}</div>
                            <div class="rule-event-value"><v-select append-to-body :calculate-position="calculateDropdownPosition"  :clearable="false" :options="getDropdownOptionsForType('Subroutine')" :reduce="x => x.code" v-model="rule.ruleAttributes.subroutineName"></v-select></div>
                        </div>
                        <!--TODO: subroutines-->
                        <div class="conditions-and-actions">
                            <div class="conditions">
                                <div class="conditions-header">
                                    <div class="conditions-title">{{ translate("conditions", workshopUiKw) }} <span class="conditions-nb">({{ rules[ruleIdx].ruleAttributes.conditions?.length || 0}})</span></div>
                                    <div class="conditions-buttons">
                                        <template v-if="rule.ruleAttributes.conditions.some(x => x.isSelected)">
                                            <img class="img-button button-action-condition button-delete" src="img/delete.png" v-on:click="deleteSelectedConditions(rule)"/>
                                            <div id="buttons-move-up-down" class="button-action-condition">
                                                <img id="button-move-up" class="img-button" src="img/move_up.png" v-on:click="moveSelectedConditions(rule, true)"/>
                                                <img id="button-move-down" class="img-button" src="img/move_down.png" v-on:click="moveSelectedConditions(rule, false)"/>
                                            </div>
                                            <img id="button-toggle" class="img-button button-action-condition" src="img/toggle.png" v-on:click="toggleSelectedConditions(rule)">
                                            <img id="button-copy" class="img-button button-action-condition" src="img/copy.png" v-on:click="copySelectedConditions(rule)"/>
                                        </template>
                                        <img v-if="clipboard?.type === 'conditions'" id="button-paste" class="img-button button-action-condition" src="img/paste.png" v-on:click="pasteConditions(rule)"/>
                                        <img id="button-select-all" class="img-button button-action-condition" src="img/select_all.png" v-on:click="selectAllConditions(rule)"/>
                                        <img id="button-add" class="img-button button-action-condition" src="img/add.png" v-on:click="addCondition(rule)"/>
                                    </div>
                                </div>
                                <div v-if="!rule.ruleAttributes.conditions?.length" class="no-values-msg font-blizzglobal">{{ translate("noConditions", workshopUiKw) }}</div>
                                <div v-else>
                                    <div v-for="(condition, conditionIdx) in rule.ruleAttributes.conditions" class="condition">
                                        <div class="comment" v-if="condition.comment">{{ condition.comment }}</div>
                                        <div class="code-and-checkbox">
                                            <div class="code-display-wrapper" :class="{'disabled': condition.isDisabled}" v-on:click="editActionOrCondition(condition, true, conditionIdx)">
                                                <div class="code-display" v-html="displayAst(condition)"></div>
                                            </div>
                                            <input type="checkbox" class="checkbox" v-model="condition.isSelected">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="actions">
                                <div class="actions-header">
                                    <div class="actions-title">{{ translate("actions", workshopUiKw) }} <span class="actions-nb">({{ rule.children.length }})</span></div>
                                    <div class="actions-buttons">
                                        <template v-if="rule.children.some(x => x.isSelected)">
                                            <img class="img-button button-action-condition button-delete" src="img/delete.png" v-on:click="deleteSelectedActions(rule)"/>
                                            <div id="buttons-move-up-down" class="button-action-condition">
                                                <img id="button-move-up" class="img-button" src="img/move_up.png" v-on:click="moveSelectedActions(rule, true)"/>
                                                <img id="button-move-down" class="img-button" src="img/move_down.png" v-on:click="moveSelectedActions(rule, false)">
                                            </div>
                                            <img id="button-toggle" class="img-button button-action-condition" src="img/toggle.png" v-on:click="toggleSelectedActions(rule)"/>
                                            <img id="button-copy" class="img-button button-action-condition" src="img/copy.png" v-on:click="copySelectedActions(rule)"/>
                                        </template>
                                        <img v-if="clipboard?.type === 'actions'" id="button-paste" class="img-button button-action-condition" src="img/paste.png" v-on:click="pasteActions(rule)"/>
                                        <img id="button-select-all" class="img-button button-action-condition" src="img/select_all.png" v-on:click="selectAllActions(rule)"/>
                                        <img id="button-add" class="img-button button-action-condition" src="img/add.png" v-on:click="addAction(rule)"/>
                                    </div>
                                </div>
                                <div v-if="rule.children.length === 0" class="no-values-msg font-blizzglobal">{{ translate("noActions", workshopUiKw) }}</div>
        
                                <div v-else v-for="(action, actionIdx) in rule.children" class="action">
                                    <div class="comment" v-if="action.comment" :style="{'margin-left': calculateActionPadding(action, actionIdx, rule.children)}" v-on:click="editActionOrCondition(action, false, actionIdx)">{{ action.comment }}</div>
                                    <div class="code-and-checkbox">
                                        <div class="code-display-wrapper" :class="{'disabled': action.isDisabled}" :style="{'margin-left': calculateActionPadding(action, actionIdx, rule.children)}" v-on:click="editActionOrCondition(action, false, actionIdx)">
                                            <div class="code-display" v-html="displayAst(action)"></div>
                                        </div>
                                        <input type="checkbox" class="checkbox" v-model="action.isSelected">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="ast-edit" v-if="astToEdit">
            <div id="edit-background">
                <div id="edit-title" class="font-bignoodle">{{ translate(astToEdit.name === "__compare__" ? (astToEditIndex === null ? "addCondition" : "editCondition") : (astToEditIndex === null ? "addAction" : "editAction"), workshopUiKw) }}</div>

                <div id="edit-content">

                    <!--<textarea rows="1" wrap="off" id="edit-comment">{{ astToEdit.comment }}</textarea>-->
                    <div id="edit-comment-wrapper">
                        <textarea v-on:input="updateTextareaHeight($event.target)" id="edit-comment" class="font-blizzglobal" :placeholder="translate('editComment', workshopUiKw)" v-model="astToEdit.comment"></textarea>
                    </div>
                    <function-display :ast="astToEdit" :depth="astToEdit.name === '__compare__' ? -1 : 0"></function-display>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="cancelEdition()">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="validateEditedAst()">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="delete-confirmation" :class="{'shown': displayDeleteConfirmationFor}">
            <div id="delete-title" class="font-bignoodle">{{ translate(displayDeleteConfirmationFor === "actions" ? "deleteActions" : displayDeleteConfirmationFor === "conditions" ? "deleteConditions" : "deleteRules", workshopUiKw, displayDeleteConfirmationFor === "actions" ? deleteForRule.children.filter(x => x.isSelected).length : displayDeleteConfirmationFor === "conditions" ? deleteForRule.ruleAttributes.conditions.filter(x => x.isSelected).length : rules.filter(x => x.isSelected).length) }}</div>
            <div class="edit-buttons">
                <button class="cancel-button font-futurano2d" v-on:click="cancelDeletion()">{{ translate("cancel", workshopUiKw) }}</button>
                <button class="ok-button font-futurano2d" v-on:click="validateDeletion()">{{ translate("ok", workshopUiKw) }}</button>
            </div>
        </div>
        <div id="variables-edit-screen" v-show="displayVariableEditor">
            <div class="variables-background">
                <div class="variables-edit-title font-bignoodle">{{ translate("editVariableNames", workshopUiKw) }}</div>
                <div id="variables-edit-wrapper">
                    <div class="variables-edit" v-for="(varArray, i) in [editedGlobalVariables, editedPlayerVariables]">
                        <div class="variables-edit-subtitle">{{ translate(["__global__", "__player__"][i], ruleKw) }}</div>
                        <div class="variables-edit-fields">
                            <div v-for="v in varArray" class="variables-edit-row">
                                <div class="variables-edit-nb">{{ v.index }}</div>
                                <input type="text" class="variables-edit-field" v-model="v.name">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reset-to-defaults">
                    <button class="reset-to-defaults-button font-futurano2d" v-on:click="resetVariablesToDefault()">{{ translate("resetToDefaults", workshopUiKw) }}</button>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="cancelVarEdition()">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="validateVariables()">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="subroutines-edit-screen" v-show="displaySubroutineEditor">
            <div class="variables-background">
                <div class="variables-edit-title font-bignoodle">{{ translate("editSubroutineNames", workshopUiKw) }}</div>
                <div id="variables-edit-wrapper">
                    <div class="variables-edit">
                        <div class="variables-edit-fields">
                            <div v-for="v in editedSubroutines" class="variables-edit-row">
                                <div class="variables-edit-nb">{{ v.index }}</div>
                                <input type="text" class="variables-edit-field" v-model="v.name">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reset-to-defaults">
                    <button class="reset-to-defaults-button font-futurano2d" v-on:click="resetSubroutinesToDefault()">{{ translate("resetToDefaults", workshopUiKw) }}</button>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="cancelSubroutineEdition()">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="validateSubroutines()">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="extensions-edit-screen" v-if="displayExtensionsEditor">
            <div class="window-background">
                <div class="window-edit-title font-bignoodle">{{ translate("editExtensions", workshopUiKw) }}</div>
                <div class="cards">
                    <div class="card">
                        <div class="card-title">{{ translate("extensionPointsAvailable", workshopUiKw) }}</div>
                        <div class="card-value">{{ availableExtensionPoints }}</div>
                        <div class="card-description font-blizzglobal">{{ translate("extensionPointsAvailableDesc", workshopUiKw) }}</div>
                    </div>
                    <div class="card">
                        <div class="card-title">{{ translate("extensionPointsSpent", workshopUiKw) }}</div>
                        <div class="card-value">{{ getSpentExtensionPoints() }}</div>
                        <div class="card-description font-blizzglobal">{{ translate("extensionPointsSpentDesc", workshopUiKw) }}</div>
                    </div>
                </div>
                <div id="extensions">
                    <div class="extension" v-for="(extension, extensionId) in customGameSettingsSchema.extensions.values">
                        <div class="extension-title">{{ translate(extensionId, customGameSettingsSchema.extensions.values) }}</div>
                        <div class="extension-description font-blizzglobal">
                            {{ translate("descriptionLocalized", customGameSettingsSchema.extensions.values[extensionId]) }}
                        </div>
                        <div class="extension-points">{{ customGameSettingsSchema.extensions.values[extensionId].points }}</div>
                        <div class="extension-checkbox">
                            <input type="checkbox" :value="extensionId" class="checkbox" v-model="editedActivatedExtensions">
                        </div>
                    </div>
                </div>
                <div class="reset-to-defaults">
                    <button class="reset-to-defaults-button font-futurano2d" v-on:click="resetExtensionsToDefault()">{{ translate("resetToDefaults", workshopUiKw) }}</button>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="cancelExtensionEdition()">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="validateExtensions()">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="metrics-screen" v-if="displayMetrics">
            <div class="window-background">
                <div class="window-edit-title font-bignoodle">{{ translate("scriptDiagnostics", workshopUiKw) }}</div>
                <div class="cards">
                    <div class="card">
                        <div class="card-title">{{ translate("totalElementCount", workshopUiKw) }}</div>
                        <div class="card-value">{{ nbElements }}</div>
                        <div class="card-description font-blizzglobal">{{ translate("totalElementCountDesc", workshopUiKw, ELEMENT_LIMIT) }}</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Size of largest rule</div>
                        <div class="card-value">IDK</div>
                        <div class="card-description font-blizzglobal">How the fuck do you calculate this shit?</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Hours spent making this UI</div>
                        <div class="card-value">63</div>
                        <div class="card-description font-blizzglobal">I am now a master at FlexBox</div>
                    </div>
                </div>
                <div class="edit-buttons">
                    <button class="ok-button font-futurano2d" v-on:click="displayMetrics = false">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="info-screen" v-if="displayInfo">
            <div class="window-background">
                <div class="window-edit-title font-bignoodle">Zez's Workshop UI Recreation [BETA]</div>
                <div id="info" class="font-blizzglobal">
                    <p>Your gamemode is saved to your browser's local storage every time you edit an action/condition, or when you view the extensions or the element count.</p>
                    <p>The UI was tested on Firefox with a resolution of 1920x1080. You can zoom or dezoom if the UI is not adapted to your screen resolution.</p>
                    <p>You can save manually by clicking on the Save button: <img src="img/save.png" width="25" height="25"/></p>
                    <p>This workshop UI uses OverPy to decompile and compile. The only known limitation is that disabled actions and conditions cannot be outputted; they will be replaced by useless actions. Some errors use the OverPy syntax for functions.</p>
                    <p>Below, you can configure some settings for the UI and for OverPy:</p>
                    <div class="setting font-futurano2d" v-for="(setting, settingId) in uiAvailableSettings">
                        <div class="setting-name">{{ setting.name }}</div>
                        <div class="setting-value">
                            <v-select append-to-body :calculate-position="calculateDropdownPosition" :clearable="false" :options="Object.keys(setting.values).map(x => ({code: x, label: setting.values[x]}))" :reduce="x => x.code" v-model="uiSettings[settingId]">
                        </div>
                    </div>
					<p>Known bugs:<br>
						<ul style="text-align: left">
							<li>The generated custom game settings are very fat</li>
							<li>Some maps are not available in OW2, yet selectable in the custom game settings</li>
							<li>The UI itself is not translated (but functions are)</li>
							<li>No tooltips</li>
							<li>No saving</li>
							<li>The AST display is not workshop-like, eg Add() instead of +</li>
							<li>The UI is slow when working with 200+ rules</li>
						</ul>
					</p>
                    <p>Feel free to join the discord if you have any questions or feedback!<br><a href="https://discord.gg/EEMjjFB" target="_blank">https://discord.gg/EEMjjFB</a></p>
                    <p>Made by Zezombye, with help from Mitsiee</p>
                </div>
                <div class="edit-buttons">
                    <button class="ok-button font-futurano2d" v-on:click="displayInfo = false">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="import-screen" v-if="displayImport">
            <div class="window-background">
                <div class="window-edit-title font-bignoodle">Import Gamemode</div>
                <div id="info" class="font-blizzglobal">
                    <p>Paste your gamemode here:</p>
                    <textarea id="decompile-text" class="font-blizzglobal" v-model="textToDecompile"></textarea>
                    <div class="setting font-futurano2d">
                        <div class="setting-name">Language</div>
                        <div class="setting-value">
                            <v-select append-to-body :calculate-position="calculateDropdownPosition" :clearable="false" :options="Object.keys(uiAvailableSettings.language.values).map(x => ({code: x, label: uiAvailableSettings.language.values[x]}))" :reduce="x => x.code" v-model="decompilationLanguage">
                        </div>
                    </div>
                    <p>Note: this will erase the existing rules.<br>The gamemode has to be copied straight from Overwatch.</p>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="displayImport = false; textToDecompile = null">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="decompile(textToDecompile)">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
        <div id="settings-screen" v-if="displaySettings">
            <div class="window-background">
                <div class="window-edit-title font-bignoodle">{{ translate("settings", workshopUiKw) }}</div>
                <div id="settings-wrapper">
					<div class="cgs-content" v-for="(categoryContent, category) in editedCustomGameSettings">
						<div class="cgs-title-wrapper">
							<img v-if="categoryContent.isCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="categoryContent.isCollapsed=false; updateTextareasHeight()">
							<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="categoryContent.isCollapsed=true"/>
							<div class="cgs-title">{{ translate(category, customGameSettingsSchema) }}</div>
						</div>
						<template v-if="!categoryContent.isCollapsed">
							<cgs-values v-if="category === 'lobby' || category === 'main'" :values="categoryContent" :schema="customGameSettingsSchema[category].values">

							</cgs-values>
							<div v-else-if="category === 'gamemodes'" v-for="(gamemodeContent, gamemode) in categoryContent" class="cgs-content">
								<template v-if="gamemode !== 'isCollapsed' && gamemode !== 'isArrayCollapsed'">
									<div class="cgs-title-wrapper">
										<img v-if="gamemodeContent.isCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="gamemodeContent.isCollapsed=false"/>
										<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="gamemodeContent.isCollapsed=true"/>
										<input type="checkbox" v-model="gamemodeContent.enabled"/>
										<div class="cgs-title">{{ translate(gamemode, customGameSettingsSchema.gamemodes.values) }}</div>
									</div>
									<div v-if="!gamemodeContent.isCollapsed && 'enabledMaps' in gamemodeContent" class="cgs-content">
										<div class="cgs-title-wrapper">
											<img v-if="gamemodeContent.isArrayCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="gamemodeContent.isArrayCollapsed=false"/>
											<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="gamemodeContent.isArrayCollapsed=true"/>
											<div class="cgs-title">{{ translate("enabledMaps", customGameSettingsSchema.gamemodes.values[gamemode].values) }}</div>
										</div>
										<cgs-values v-if="!gamemodeContent.isArrayCollapsed" :values="Object.keys(mapKw).filter(x => mapKw[x].gamemodes.includes(gamemode))" :schema="mapKw" :array-obj="gamemodeContent" :array-key="'enabledMaps'"></cgs-values>
									</div>
									<cgs-values v-if="!gamemodeContent.isCollapsed" :values="gamemodeContent" :schema="customGameSettingsSchema[category].values[gamemode].values">
									</cgs-values>
								</template>

							</div>
							<div v-else-if="category === 'heroes'" v-for="(teamContent, team) in categoryContent" class="cgs-content">
								<template v-if="team !== 'isCollapsed'">

									<div class="cgs-title-wrapper">
										<img v-if="teamContent.isCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="teamContent.isCollapsed=false"/>
										<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="teamContent.isCollapsed=true"/>
										<div class="cgs-title">{{ translate(team, customGameSettingsSchema.heroes.teams) }}</div>
									</div>
									<div v-if="!teamContent.isCollapsed" class="cgs-content">
										<div class="cgs-title-wrapper">
											<img v-if="teamContent.isArrayCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="teamContent.isArrayCollapsed=false"/>
											<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="teamContent.isArrayCollapsed=true"/>
											<div class="cgs-title">{{ translate("enabledHeroes", customGameSettingsSchema.heroes.values) }}</div>
										</div>
										<cgs-values v-if="!teamContent.isArrayCollapsed" :values="Object.keys(heroKw)" :schema="heroKw" :array-obj="teamContent" :array-key="'enabledHeroes'"></cgs-values>
									</div>
									<template v-if="!teamContent.isCollapsed" v-for="(heroContent, hero) in teamContent">
										<div class="cgs-content" v-if="hero !== 'isCollapsed' && hero !== 'isArrayCollapsed' && hero !== 'enabledHeroes'">

											<div class="cgs-title-wrapper">
												<template v-if="'isCollapsed' in heroContent">
													<img v-if="heroContent.isCollapsed" class="img-button" src="img/expand_rule.png" v-on:click="heroContent.isCollapsed=false"/>
													<img v-else class="img-button" src="img/collapse_rule.png" v-on:click="heroContent.isCollapsed=true"/>
												</template>
												<div class="cgs-title">{{ translate(hero, (hero === 'general' ? customGameSettingsSchema.gamemodes.values : hero === 'enabledHeroes' ? customGameSettingsSchema.heroes.values : heroKw)) }}</div>
											</div>
											<cgs-values v-if="!heroContent.isCollapsed" :values="heroContent" :schema="customGameSettingsSchema[category].values[hero].values">
			
											</cgs-values>
										</div>
									</template>
								</template>
							</div>
						</template>
					</div>
                </div>
                <div class="edit-buttons">
                    <button class="cancel-button font-futurano2d" v-on:click="displaySettings = false">{{ translate("cancel", workshopUiKw) }}</button>
                    <button class="ok-button font-futurano2d" v-on:click="validateSettings()">{{ translate("ok", workshopUiKw) }}</button>
                </div>
            </div>
        </div>
    </div>
    </div>

</div>
    <template id="function-display-template">
        <div class="argument-value-wrapper-wrapper">
            <div class="argument-value-wrapper" v-if="!(ast.name === '__compare__' && ast.parent.name === '__rule__')">
                <div v-for="i in depth" class="indent-marker"></div>
                <div class="argument" :class="{'argument-number': ast.type !== 'Variable' && $root.isTypeSuitable(['FloatLiteral', 'IntLiteral'], ast.type, false)}">{{ ast.parent.name === "__rule__" ? $root.translate("action", $root.workshopUiKw) : ast.parent.parent.name === "__rule__" && ast.parent.name !== "__compare__" ? $root.actionKw[ast.parent.name].args[astIdx].name : ast.parent.name === "__array__" ? "["+astIdx+"]" : $root.valueFuncKw[ast.parent.name].args[astIdx].name }}</div>
                <div class="value">
                    <img src="img/array_add.png" class="array-img-button array-add" v-if="ast.name === '__array__'" v-on:click="$root.addToArray(ast)"/>
                    <img src="img/array_remove.png" class="array-img-button array-remove" v-if="ast.parent.name === '__array__'" v-on:click="$root.removeFromArray(ast.parent, astIdx)"/>
                    <div class="array-up-down" v-if="ast.parent.name === '__array__'">
                        <img src="img/array_up.png" class="array-img-button array-up" v-on:click="$root.moveArrayElement(ast.parent, astIdx, true)"/>
                        <img src="img/array_down.png" class="array-img-button array-down" v-on:click="$root.moveArrayElement(ast.parent, astIdx, false)"/>
                    </div>
                    <div v-if="ast.type !== 'Variable' && $root.isTypeSuitable(['FloatLiteral', 'IntLiteral'], ast.type, false)" class="number-input">
                        <input type="number" step="0.001" class="font-futurano2d" v-model="ast.name">
                    </div>
                    <div class="value-string" v-else-if="ast.type === 'CustomStringLiteral'">
                        <textarea oninput="this.style.height = ''; this.style.height = this.scrollHeight +'px'" class="custom-string-textarea font-blizzglobal" v-model="ast.name">{{ ast.name }}</textarea>
                    </div>
                    <div class="value-dropdown" v-else>
                        <v-select append-to-body :calculate-position="$root.calculateDropdownPosition"  :clearable="false" :options="$root.getDropdownOptionsForType(ast.type)" :reduce="x => x.code" v-model="ast.name" v-on:input="$root.rebuildAst(ast)">
                        </v-select>
                    </div>
                </div>
            </div>
            <function-display v-for="(arg, idx) in ast.args" :ast="arg" :ast-idx="idx" :depth="depth+1"></function-display>
        </div>
    </template>
	<template id="custom-game-settings-values">
		<div class="cgs-values">
			<template v-if="arrayObj">
				<div class="cgs-setting-name-value"  v-for="v in values">
					<div class="cgs-setting-name">
						{{ $root.translate(v, schema) }}
					</div>
					<div class="cgs-setting-value">
						<input type="checkbox" :value="v" v-model="arrayObj[arrayKey]"/>
					</div>
				</div>
			</template>
			<template v-else v-for="(value, key) in values">
				<div class="cgs-setting-name-value" v-if="key !== 'isCollapsed' && key !== 'isArrayCollapsed' && key !== 'enabled' && key !== 'enabledMaps' && key !== 'enabledHeroes'">
					<div class="cgs-setting-name">
						{{ $root.translate(key, schema) }}
					</div>
					<div class="cgs-setting-value">
						<template v-if='["__boolYesNo__", "__boolOnOff__", "__boolEnabled__"].includes(schema[key].values)'>
							<input type="checkbox" v-model="values[key]"/>
						</template>
						<template v-else-if="schema[key].values === '__boolReverseOnOff__'">
							<input type="checkbox" v-model="values[key]" :true-value="false" :false-value="true"/>
						</template>
						<template v-else-if="['__percent__', '__int__', '__float__'].includes(schema[key].values)">
							<input type="number" :min="schema[key].min" :max="schema[key].max" v-model.number="values[key]"/>
							<input type="range" :min="schema[key].min" :max="schema[key].max" v-model.number="values[key]"/>
						</template>
						<template v-else-if="schema[key].values === '__string__'">
							<textarea oninput="this.style.height = ''; this.style.height = this.scrollHeight +'px'" class="font-blizzglobal" v-model="values[key]"></textarea>
						</template>
						<template v-else>
							<v-select append-to-body :calculate-position="$root.calculateDropdownPosition" :clearable="false" :options="$root.getDropdownOptionsForKeywordObj(schema[key].values)" :reduce="x => x.code" v-model="values[key]"></v-select>
						</template>
					</div>
				</div>
			</template>
		</div>
	</template>

    <script>

        console.debug = function() {}
        Vue.component('v-select', VueSelect.VueSelect);
        Vue.component("function-display", {
            props: ["ast", "astIdx", "depth"],
            template: "#function-display-template",
        })
        Vue.component("cgs-values", {
            props: ["values", "schema", "arrayObj", "arrayKey"],
            template: "#custom-game-settings-values",
        })

        const oldConsoleInfo = console.info;
        const oldConsoleError = console.error;
        const oldConsoleWarn = console.warn;

        var app = new Vue({
            "el": "#app-wrapper-wrapper",
            "data": {
                decompilationLanguage: "en-US",
                textToDecompile: null,
                displayDeleteConfirmationFor: null,
                deleteForRule: null,
                displayInfo: !window.location.pathname.endsWith(".html"),
                displayMetrics: false,
                displayVariableEditor: false,
                displaySubroutineEditor: false,
                displayExtensionsEditor: false,
                displayImport: false,
				displaySettings: false,
                editedGlobalVariables: [],
                editedPlayerVariables: [],
                editedSubroutines: [],
                activatedExtensions: [],
                editedActivatedExtensions: [],
                availableExtensionPoints: 0,
                spentExtensionPoints: 0,
                nbElements: 0,
                clipboard: {},
                compiledGamemode: null,
                customGameSettings: {
                    "main": {
                        "description": "Some awesome game mode",
                        "modeName": "GameMode v1.0"
                    },
                    "gamemodes": {
                        "skirmish": {
                            "heroLimit": "off",
                            "respawnTime%": 30
                        }
                    },
                },
				editedCustomGameSettings: null,
                astToEdit: null,
                astToEditIsCondition: null,
                astToEditParent: null,
                astToEditIndex: null,
                "rules": [],

                uiAvailableSettings: {
                    optimization: {
                        name: "Optimization",
                        values: {
                            none: "No optimization",
                            speed: "Optimize for speed (default)",
                            size: "Optimize for size (reduce element count)",
                        }
                    },
                    language: {
                        name: "UI Language",
                        values: {
                            "en-US": " English [en-US]",
                            "de-DE": " Deutsch [de-DE]",
                            "es-ES": " Espaol (EU) [es-ES]",
                            "es-MX": " Espaol (AL) [es-MX]",
                            "fr-FR": " Franais [fr-FR]",
                            "it-IT": " Italiano [it-IT]",
                            "ja-JP": "  [ja-JP]",
                            "ko-KR": "  [ko-KR]",
                            "pl-PL": " Polski [pl-PL]",
                            "pt-BR": " Portugus [pt-BR]",
                            "ru-RU": "  [ru-RU]",
                            "zh-CN": "  [zh-CN]",
                            "zh-TW": "  [zh-TW]",
                        }
                    },
                    compilationLanguage: {
                        name: "Compilation Language",
                        values: {
                            "en-US": " English [en-US]",
                            "de-DE": " Deutsch [de-DE]",
                            "es-ES": " Espaol (EU) [es-ES]",
                            "es-MX": " Espaol (AL) [es-MX]",
                            "fr-FR": " Franais [fr-FR]",
                            "it-IT": " Italiano [it-IT]",
                            "ja-JP": "  [ja-JP]",
                            "ko-KR": "  [ko-KR]",
                            "pl-PL": " Polski [pl-PL]",
                            "pt-BR": " Portugus [pt-BR]",
                            "ru-RU": "  [ru-RU]",
                            "zh-CN": "  [zh-CN]",
                            "zh-TW": "  [zh-TW]",
                        }
                    },
                    background: {
                        name: "Background",
                        values: {
                            "random": "Random",
                            "blizzard_world.jpg": "Blizzard World #1",
                            "blizzard_world_2.jpg": "Blizzard World #2",
                            "busan.jpg": "Busan",
                            "chateau_halloween.jpg": "Chteau Halloween",
                            "dorado.jpg": "Dorado",
                            "eichenwalde.jpg": "Eichenwalde",
                            "eichenwalde_halloween.jpg": "Eichenwalde Halloween #1",
                            "eichenwalde_halloween_2.jpg": "Eichenwalde Halloween #2",
                            "hanamura.jpg": "Hanamura",
                            "kings_row.jpg": "King's Row",
                            "monte_carlo.jpg": "Monte Carlo #1",
                            "monte_carlo_2.jpg": "Monte Carlo #2",
                            "new_queen_street.jpg": "New Queen Street",
                            "oasis.jpg": "Oasis",
                            "paraiso.jpg": "Paraiso",
                            "paris.jpg": "Paris",
                            "rialto.jpg": "Rialto",
                            "temple_of_anubis.jpg": "Temple of Anubis",
                            "volskaya.jpg": "Volskaya",
                            "tf2.jpg": "TF2 #1",
                            "tf2_2.jpg": "TF2 #2",
                            "portal_2.jpg": "Portal 2",
                            "workshop.jpg": "Workshop",
                            "forge.jpg": "Forge",
         }
                    }
                },
                uiSettings: {
                    optimization: "speed",
                    language: "en-US",
                    compilationLanguage: "en-US",
                    background: "random",
                },

                ruleAttributesDisplayNamesKw,
                workshopUiKw,
                eventKw,
                eventTeamKw,
                eventPlayerKw,
                actionKw,
                valueKw,
                valueFuncKw,
                stringKw,
                ruleKw,
				heroKw,
				mapKw,
                customGameSettingsSchema,
                constantValues,
                astToString,
                isTypeSuitable,
                translateVarToWs,
                translateSubroutineToWs,
                escapeString,
                functionNameToString,
                globalVariables: defaultVarNames.map((x, i) => ({name: x, index: i})),
                playerVariables: defaultVarNames.map((x, i) => ({name: x, index: i})),
                subroutines: defaultSubroutineNames.map((x, i) => ({name: x, index: i})),
                ELEMENT_LIMIT,
            },
            computed: {
                background: function() {
                    if (this.uiSettings.background === "random") {
                        var availableBackgrounds = Object.keys(this.uiAvailableSettings.background.values).filter(x => x !== "random")
                        return availableBackgrounds[Math.floor(Math.random() * availableBackgrounds.length)];
                    } else {
                        return this.uiSettings.background;
                    }
                }
            },
            "methods": {
                info: function(str) {
                    oldConsoleInfo(str);
                    Toastify({
                        text: str,
                        duration: 4000,
                        gravity: "bottom", // `top` or `bottom`
                        position: "left", // `left`, `center` or `right`
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                        className: "info",
                    }).showToast();
                },
                warn: function(str) {
                    oldConsoleWarn(str);
                    Toastify({
                        text: str,
                        duration: 5000,
                        gravity: "bottom", // `top` or `bottom`
                        position: "left", // `left`, `center` or `right`
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                        className: "warning",
                    }).showToast();
                },
                error: function(str) {
                    oldConsoleError(str);
                    str = ""+str;
                    if (str.startsWith("Error: ")) {
                        str = str.substring("Error: ".length);
                    }
                    Toastify({
                        text: str,
                        duration: 5000,
                        gravity: "bottom", // `top` or `bottom`
                        position: "left", // `left`, `center` or `right`
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                        className: "error",
                    }).showToast();
                },
                translate: function(keyword, keywordObj, ...args) {
					if (!keywordObj) {
						throw new Error("Invalid keywordobj for '"+keyword+"'");
					}
                    if (!(keyword in keywordObj)) {
                        throw new Error("Could not translate '"+keyword+"'");
                    }
                    var result = null;
                    if (this.uiSettings.language in keywordObj[keyword]) {
                        result = keywordObj[keyword][this.uiSettings.language];
                    } else if ("en-US" in keywordObj[keyword]) {
                        result = keywordObj[keyword]["en-US"];
                    } else {
						throw new Error("Invalid keywordobj for '"+keyword+"': "+JSON.stringify(keywordObj));
					}
                    if (result.includes("%1$s")) {
                        result = result.replace("%1$s", args[0]);
                        if (result.includes("|Rpl")) {
                            result = result.replace(/\|Rpl(.*):(.*);/, +args[0] === 1 ? "$1" : "$2")
                        }
                    }
                    return result;
                },
                getDropdownOptionsForType: function(type) {
                    if (type === "GlobalVariable") {
                        return this.globalVariables.slice().sort((a,b) => (a.index - b.index)).map(x => ({label: x.name, code: x.index}));
                    } else if (type === "PlayerVariable") {
                        return this.playerVariables.slice().sort((a,b) => (a.index - b.index)).map(x => ({label: x.name, code: x.index}));
                    } else if (type === "Subroutine") {
                        return this.subroutines.slice().sort((a,b) => (a.index - b.index)).map(x => ({label: x.name, code: x.index}));
                    }
                    keywordObj = null
                    if (type === "void") {
                        keywordObj = this.actionKw;
                    } else if (type in this.constantValues) {
                        keywordObj = this.constantValues[type];
                    } else if (type === "event") {
                        keywordObj = this.eventKw;
                    } else if (type === "eventPlayer") {
                        keywordObj = this.eventPlayerKw;
                    } else if (type === "eventTeam") {
                        keywordObj = this.eventTeamKw;
                    } else {
                        keywordObj = this.valueFuncKw;
                    }
					return this.getDropdownOptionsForKeywordObj(keywordObj);
                },
				getDropdownOptionsForKeywordObj: function(keywordObj) {

                    return Object.keys(keywordObj).filter(x => typeof keywordObj[x] === "object" && !keywordObj[x].onlyInOw1 && x !== "__global__").map(x => ({"label": this.uiSettings.language in keywordObj[x] ? keywordObj[x][this.uiSettings.language] : keywordObj[x]["en-US"], "code": x})).slice().sort((a,b) => (a.label.localeCompare(b.label)))
				},
                decompile: function(content) {
                    try {

                        resetGlobalVariables(this.decompilationLanguage);
                        [customGameSettings, rules] = decompileAllRulesToAst(content);
                        if (!customGameSettings) {
                            console.error("Gamemode must have settings");
                            return;
                        }
                        console.log(customGameSettings);
                        console.log(rules);
                        this.customGameSettings = JSON.parse(customGameSettings.replace("settings {", "{"));
                        this.globalVariables = globalVariables;
                        this.playerVariables = playerVariables;
                        this.subroutines = subroutines;
                        this.activatedExtensions = [...activatedExtensions];
                        //Add default var names (if eg there are no player variables, then adding a player variable will error because we cannot select one)
                        //Plus, we need var names to be in order for the UI
                        for (var i = 0; i < 128; i++) {
                            if (!this.globalVariables.map(x => x.index).includes(i)) {
                                this.globalVariables.push({index: i, name: defaultVarNames[i]})
                            }
                            if (!this.playerVariables.map(x => x.index).includes(i)) {
                                this.playerVariables.push({index: i, name: defaultVarNames[i]})
                            }
                            if (!this.subroutines.map(x => x.index).includes(i)) {
                                this.subroutines.push({index: i, name: defaultSubroutineNames[i]})
                            }
                        }
                        for (var rule of rules) {
                            if ("conditions" in rule.ruleAttributes) {
                                for (var i = 0; i < rule.ruleAttributes.conditions.length; i++) {
                                    rule.ruleAttributes.conditions[i] = this.adjustAstForWorkshop(rule.ruleAttributes.conditions[i]);
                                    rule.ruleAttributes.conditions[i].parent = rule;
                                    rule.ruleAttributes.conditions[i].isSelected = false;
                                    rule.ruleAttributes.conditions[i].isDisabled ||= false;
                                }
                            } else {
                                rule.ruleAttributes.conditions = [];
                            }
                            if ("subroutineName" in rule.ruleAttributes) {
                                rule.ruleAttributes.subroutineName = this.subroutines.filter(x => x.name === rule.ruleAttributes.subroutineName)[0].index;
                            }
                            for (var i = 0; i < rule.children.length; i++) {
                                rule.children[i] = this.adjustAstForWorkshop(rule.children[i]);
                                rule.children[i].parent = rule;
                                rule.children[i].isSelected = false;
                                rule.children[i].isDisabled ||= false;
                            }

                            if (rules.length > 50) {
                                rule.isCollapsed = true;
                            } else {
                                rule.isCollapsed = false;
                            }
                            rule.isSelected = false;
                        }
                        this.rules = rules;
                        this.globalVariables.sort((a,b) => (a.index - b.index))
                        this.playerVariables.sort((a,b) => (a.index - b.index))
                        this.subroutines.sort((a,b) => (a.index - b.index))
                        console.info("Successfully imported!");
                        this.textToDecompile = null;
                        this.displayImport = false;
                    } catch (e) {
                        console.error(e + ", contact Zezombye about this");
                    }
                },
                adjustAstForWorkshop: function(ast) {
                    //We cannot use overpy functions because they also do a bunch of stuff such as optimization
                    //This function does stuff like replacing __equals__(1,2) by __compare__(1, ==, 2)
                    const comparisonFuncToOpMapping = {
                        "__equals__": "==",
                        "__inequals__": "!=",
                        "__lessThanOrEquals__": "<=",
                        "__greaterThanOrEquals__": ">=",
                        "__lessThan__": "<",
                        "__greaterThan__": ">",
                    }
                    if (ast.name in comparisonFuncToOpMapping) {
                        var result = new Ast("__compare__", [this.adjustAstForWorkshop(ast.args[0]), new Ast(comparisonFuncToOpMapping[ast.name], [], [], "__Operator__"), this.adjustAstForWorkshop(ast.args[1])]);
                        result.comment = ast.comment;
                        result.isDisabled = ast.isDisabled;
                        return result;
                    } else if (ast.name === "__assignTo__" || ast.name === "__modifyVar__") {

                        var newName = ast.name === "__assignTo__" ? "__set" : "__modify";
                        if (ast.args[0].name === "__globalVar__") {
                            //A = 3 -> __setGlobalVariable__(A, 3)
                            newName += "GlobalVariable__";
                            ast.args = [ast.args[0].args[0]].concat(ast.args.slice(1));

                        } else if (ast.args[0].name === "__playerVar__") {
                            //eventPlayer.A = 3 -> __setPlayerVariable__(eventPlayer, A, 3)
                            newName += "PlayerVariable__";
                            ast.args = [ast.args[0].args[0], ast.args[0].args[1]].concat(ast.args.slice(1));

                        } else if (ast.args[0].name === "__valueInArray__") {
                            if (ast.args[0].args[0].name === "__globalVar__") {
                                //A[0] = 3 -> __setGlobalVariableAtIndex__(A, 0, 3)
                                newName += "GlobalVariableAtIndex__";
                                ast.args = [ast.args[0].args[0].args[0], ast.args[0].args[1]].concat(ast.args.slice(1));

                            } else if (ast.args[0].args[0].name === "__playerVar__") {
                                //eventPlayer.A[0] = 3 -> __setPlayerVariableAtIndex__(eventPlayer, A, 0, 3)
                                newName += "PlayerVariableAtIndex__";
                                ast.args = [ast.args[0].args[0].args[0], ast.args[0].args[0].args[1], ast.args[0].args[1]].concat(ast.args.slice(1));
                            } else {
                                throw new Error("Cannot modify or assign to "+this.functionNameToString(ast.args[0].args[0]))
                            }
                        } else {
                            throw new Error("Cannot modify or assign to "+this.functionNameToString(ast.args[0]))
                        }
                        ast.name = newName;

                    } else if (ast.name === "__for__") {
                        var newName = "";
                        if (ast.args[0].name === "__globalVar__") {
                            newName = "GlobalVariable";
                            ast.args = [ast.args[0].args[0]].concat(ast.args.slice(1));

                        } else if (ast.args[0].name === "__playerVar__") {
                            newName = "PlayerVariable";
                            ast.args = [ast.args[0].args[0], ast.args[0].args[1]].concat(ast.args.slice(1));

                        } else {
                            error("Expected a variable for 1st argument of "+functionNameToString(ast)+", but got "+functionNameToString(ast.args[0]));
                        }
                        newName = "__for"+newName+"__";
                        ast.name = newName;

                    } else if (ast.name === "__negate__") {
                        ast.args[0].args[0].name = ""+(-ast.args[0].args[0].name);
                        ast.args[0].args[0].numValue = -ast.args[0].args[0].numValue;
                        ast = ast.args[0];
                    } else if (ast.type === "TeamLiteral") {
                        return new Ast("__team__", [ast]);

                    } else if (ast.type === "ColorLiteral" && ast.parent.name !== "__color__") {
                        return new Ast("__color__", [ast]);

                    } else if (ast.type === "ButtonLiteral" && ast.parent.name !== "__button__") {
                        return new Ast("__button__", [ast]);

                    } else if (ast.name === "__customString__") {
                        //add potentially missing arguments
                        for (var i = 0; i < 4; i++ ) {
                            if (ast.args.length <= i) {
                                ast.args.push(new Ast("null"))
                            }
                        }
                    } else if (ast.type === "GlobalVariable") {
                        ast.name = this.globalVariables.filter(x => x.name === ast.name)[0].index;
                    } else if (ast.type === "PlayerVariable") {
                        ast.name = this.playerVariables.filter(x => x.name === ast.name)[0].index;
                    } else if (ast.type === "Subroutine") {
                        ast.name = this.subroutines.filter(x => x.name === ast.name)[0].index;
                    }
                    for (var i = 0; i < ast.args.length; i++) {
                        ast.args[i] = this.adjustAstForWorkshop(ast.args[i]);
                        ast.args[i].parent = ast;
                    }
                    return ast;
                },
                compileGamemode: function() {
                    //Adjust AST for overpy

                    function recursivelySetFilestack(ast, fileStack) {
                        ast.fileStack = fileStack;
                        for (var arg of ast.args) {
                            recursivelySetFilestack(arg, fileStack);
                        }
                    }

                    var rules = structuredClone(this.rules);
                    for (let [ruleIdx, rule] of rules.entries()) {
						if (rule.children.length === 0) {
							rule.ruleAttributes.isDelimiter = true;
						}
                        rule.fileStack = [{ruleNb: ruleIdx, rule: rule.ruleAttributes.name}]
                        for (var i = 0; i < rule.children.length; i++) {
                            var comment = rule.children[i].comment;
                            if (rule.children[i].isDisabled) {
                                var dummyAction = getAstForUselessInstruction();
                                rule.children[i] = dummyAction;
                            } else {
                                resetGlobalVariables(this.uiSettings.language);
                                globalVariables = structuredClone(this.globalVariables);
                                playerVariables = structuredClone(this.playerVariables);
                                subroutines = structuredClone(this.subroutines);
                                rule.children[i] = decompile(this.displayAst(rule.children[i], false))
                            }
                            rule.children[i].comment = comment;
                            rule.children[i].parent = rule;

                            recursivelySetFilestack(rule.children[i], [{ruleNb: ruleIdx, rule: rule.ruleAttributes.name, actionNb: i+1}])

                        }

                        //console.log(rule.ruleAttributes.name);
                        //put the depth and remove the __end__
                        for (var i = rule.children.length-1; i >= 0; i--) {
                            if (["__for__", "__if__", "__elif__", "__else__", "__while__"].includes(rule.children[i].name)) {
                                var depth = 0;
                                for (var j = i+1; j < rule.children.length; j++) {
                                    if (rule.children[j].name === "__end__" && depth === 0) {
                                        break;
                                    } else if (rule.children[j].name === "__end__") {
                                        depth--;
                                    } else if (["__if__", "__elif__", "__else__"].includes(rule.children[i].name) && ["__else__", "__elif__"].includes(rule.children[j].name) && depth === 0) {
                                        break;
                                    } else {
                                        if (["__for__", "__if__", "__while__"].includes(rule.children[j].name)) {
                                            depth++;
                                        }
                                        rule.children[i].children.push(rule.children[j]);
                                        rule.children[j].parent = rule.children[i];
                                    }
                                }
                                rule.children.splice(i+1, j-i-1);
                            }
                        }
                        rule.children = rule.children.filter(x => x.name !== "__end__");
                        
                        rule.ruleAttributes.conditionComments = [];
                        rule.ruleAttributes.conditions = rule.ruleAttributes.conditions.filter(x => !x.isDisabled);
                        for (var i = 0; i < rule.ruleAttributes.conditions.length; i++) {
                            
                            resetGlobalVariables(this.uiSettings.language);
                            globalVariables = structuredClone(this.globalVariables);
                            playerVariables = structuredClone(this.playerVariables);
                            subroutines = structuredClone(this.subroutines);
                            rule.ruleAttributes.conditionComments.push(rule.ruleAttributes.conditions[i].comment);
                            rule.ruleAttributes.conditions[i] = decompile(this.displayAst(rule.ruleAttributes.conditions[i], false));
                            rule.ruleAttributes.conditions[i].parent = new Ast("@Condition", [], [], "__Annotation__");
                            recursivelySetFilestack(rule.ruleAttributes.conditions[i], [{ruleNb: ruleIdx, rule: rule.ruleAttributes.name, conditionNb: i+1}])
                        }
                        
                        if ("subroutineName" in rule.ruleAttributes) {
                            rule.ruleAttributes.subroutineName = this.subroutines.filter(x => x.index === rule.ruleAttributes.subroutineName)[0].name
                            rule.name = "__def__";
                            delete rule.ruleAttributes.event;
                            rule.ruleAttributes.conditions = undefined;
                        }
                    }

                    resetGlobalVariables(this.uiSettings.compilationLanguage);
                    if (this.uiSettings.optimization === "none") {
                        enableOptimization = false;
                    } else if (this.uiSettings.optimization === "size") {
                        optimizeForSize = true;
                    }
                    activatedExtensions = this.activatedExtensions;
                    compileCustomGameSettings(structuredClone(this.customGameSettings));
                    globalVariables = structuredClone(this.globalVariables);
                    playerVariables = structuredClone(this.playerVariables);
                    subroutines = structuredClone(this.subroutines);

                    return compileRules(rules)
                    
                },
                saveGamemode: function() {
                    if (this.compiledGamemode) {
                        var result = this.compiledGamemode;
                    } else {
                        var result = this.compileGamemode();
                    }
                    navigator.clipboard.writeText(result).then(() => {
                        this.compiledGamemode = null;
                        console.info("Successfully compiled! (copied into clipboard)");
                    }).catch((e) => {
                        this.compiledGamemode = result;
                        this.error("Compilation took too long, please click again to copy.");
                    });
                },
                displayHtml: function(str, actuallyDisplayHtml=true, category) {
                    if (actuallyDisplayHtml) {
                        return "<span class='code-"+category+"'>"+ str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;')+"</span>";
                    } else {
                        return str;
                    }
                },
                displayAst: function(ast, useHtml=true) {
                    const funcToOpMapping = {
                        "__add__": "+=",
                        "__subtract__": "-=",
                        "__multiply__": "*=",
                        "__divide__": "/=",
                        "__modulo__": "%=",
                        "__raiseToPower__": "**=",
                    }
                    var result = "";
                    if (ast.name === "__compare__" && ast.parent.name === "__rule__") {
                        return ast.args.map(x => this.displayAst(x, useHtml)).join(" ")

                    } else if (ast.type === "GlobalVariable") {
                        result += this.displayHtml(this.globalVariables.filter(x => x.index === +ast.name)[0].name, useHtml, "var");
                    } else if (ast.type === "PlayerVariable") {
                        result += this.displayHtml(this.playerVariables.filter(x => x.index === +ast.name)[0].name, useHtml, "var");
                    } else if (ast.type === "Subroutine") {
                        result += this.displayHtml(this.subroutines.filter(x => x.index === +ast.name)[0].name, useHtml, "var");

                    } else if (ast.name === "__team__") {
                        return this.displayAst(ast.args[0], useHtml);

                    } else if (["CustomStringLiteral","FullwidthStringLiteral", "BigLettersStringLiteral"].includes(ast.type)) {
                        result += this.displayHtml(this.escapeString(ast.name, true), useHtml, "string");
                    } else if (ast.type === "LocalizedStringLiteral") {
                        result += this.displayHtml(this.escapeString(tows(ast.name, this.stringKw), true), useHtml, "var");

                    } else if (ast.name === "__team__") {
                        return this.displayAst(ast.args[0], useHtml);

                    } else if (ast.name === "__number__") {
                        return this.displayHtml((+ast.args[0].name)+"", useHtml, "var");

                    } else if (ast.name === "__globalVar__") {
                        return this.displayHtml(this.translate("__global__", this.valueKw), useHtml, "var")+"."+this.displayAst(ast.args[0], useHtml);

                    } else if (ast.name === "__setGlobalVariable__") {
                        return this.displayHtml(this.translate("__global__", this.valueKw), useHtml, "var")+"."+this.displayAst(ast.args[0], useHtml)+" = "+this.displayAst(ast.args[1], useHtml);

                    } else if (ast.name === "__modifyGlobalVariable__" && ast.args[1].name in funcToOpMapping) {
                        return this.displayHtml(this.translate("__global__", this.valueKw), useHtml, "var")+"."+this.displayAst(ast.args[0], useHtml)+" "+funcToOpMapping[ast.args[1].name]+" "+this.displayAst(ast.args[2], useHtml);
                        
                    } else if (ast.name === "__setGlobalVariableAtIndex__") {
                        return this.displayHtml(this.translate("__global__", this.valueKw), useHtml, "var")+"."+this.displayAst(ast.args[0], useHtml)+"["+this.displayAst(ast.args[1], useHtml)+"] = "+this.displayAst(ast.args[2], useHtml);

                    } else if (ast.type === "void") {
                        result += this.displayHtml(this.translate(ast.name, this.actionKw), useHtml, "operator");

                    } else if (this.isTypeSuitable(["Object", "Array"], ast.type)){
                        result += this.displayHtml(this.translate(ast.name, this.valueKw), useHtml, "value");

                    } else if (ast.type in this.constantValues) {
                        if (!(ast.name in this.constantValues[ast.type])) {
                            throw new Error("Unknown "+ast.type.replace("Literal", "").toLowerCase()+" '"+ast.name+"'");
                        }
                        result += this.displayHtml(this.translate(ast.name, this.constantValues[ast.type]), useHtml, (ast.type === "__Operator__" ? "operator" : "value"));
                    } else {
                        throw new Error("Unknown type '"+ast.type+"' of '"+ast.name+"'");
                    }
                    if (ast.args.length > 0) {
                        if (ast.name === "__customString__" || ast.name === "__localizedString__") {
                            maxStrArg = ast.args[0].name.includes("{2}") ? 3 : ast.args[0].name.includes("{1}") ? 2 : ast.args[0].name.includes("{0}") ? 1 : 0
                            result += "(" + ast.args.slice(0, maxStrArg+1).map(x => this.displayAst(x, useHtml)).join(", ") + ")";
                        } else {
                            result += "(" + ast.args.map(x => this.displayAst(x, useHtml)).join(", ") + ")";
                        }
                    }
                    return result;
                },
                calculateActionPadding: function(action, actionIdx, ruleChildren) {
                    var indent = 0;
                    if (actionIdx === 0) {
                        indent = 0;
                    } else {
                        if (!ruleChildren[actionIdx-1].isDisabled && ["__if__", "__elif__", "__else__", "__while__", "__forGlobalVariable__", "__forPlayerVariable__"].includes(ruleChildren[actionIdx-1].name)) {
                            indent = ruleChildren[actionIdx-1].indent + 1;
                        } else {
                            indent = ruleChildren[actionIdx-1].indent;
                        }
                        if (!action.isDisabled && (action.name === "__end__" || action.name === "__else__" || action.name === "__elif__")) {
                            indent--;
                        }
                    }
                    if (indent < 0) {
                        indent = 0;
                    }
                    if (indent > 5) {
                        indent = 5;
                    }
                    action.indent = indent;
                    return indent*25+"px";
                },
				updateTextareasHeight: function() {
                    Vue.nextTick(() => {
                        for (var textarea of document.getElementsByTagName("textarea")) {
                            this.updateTextareaHeight(textarea);
                        }
                    })
				},
                editActionOrCondition: function(ast, isCondition, index) {
                    this.astToEdit = structuredClone(ast);
                    this.astToEditParent = ast.parent;
                    this.astToEditIsCondition = isCondition;
                    this.astToEditIndex = index;
                    this.updateTextareasHeight();
                    console.log(ast);
                },
                cancelEdition: function() {
                    this.astToEdit = null;
                },
                validateEditedAst: function() {
                    console.log(this.astToEdit);
                    console.log(this.astToEditParent);
                    console.log(this.astToEditIsCondition);
                    console.log(this.astToEditIndex);
                    if (this.astToEditIsCondition) {
                        if (this.astToEditIndex === null) {
                            this.astToEditParent.ruleAttributes.conditions.push(this.astToEdit);
                        } else {
                            this.astToEditParent.ruleAttributes.conditions[this.astToEditIndex] = this.astToEdit;
                        }
                    } else {
                        if (this.astToEditIndex === null) {
                            this.astToEditParent.children.push(this.astToEdit);
                        } else {
                            this.astToEditParent.children[this.astToEditIndex] = this.astToEdit;
                        }
                    }
                    this.astToEdit.parent = this.astToEditParent;
                    this.astToEdit = null;
                    this.compileGamemode();
                },
                rebuildAst: function(ast) {
                    console.log("Rebuilding AST: "+ast.name);
                    //When selecting a new function, recreate its arguments using defaults
                    if (ast.type in this.constantValues || ["FloatLiteral", "GlobalVariable", "PlayerVariable", "Subroutine"].includes(ast.type)) {
                        return; //no args
                    }
                    ast.args = [];
                    keywordObj = (ast.type === "void" ? this.actionKw : this.valueFuncKw);
                    if (keywordObj[ast.name].args !== null) {
                        for (var arg of keywordObj[ast.name].args) {
                            var astType = arg.type;
                            if (astType in this.constantValues) {
                                var astName = Object.keys(constantValues[astType])[0];
                            } else if (astType === "FloatLiteral") {
                                var astName = "0";
                            } else if (astType === "GlobalVariable") {
                                var astName = this.globalVariables[0].index;
                            } else if (astType === "PlayerVariable") {
                                var astName = this.playerVariables[0].index;
                            } else if (astType === "Subroutine") {
                                var astName = this.subroutines[0].index;
                            } else {
                                var astName = "__number__";
                                astType = "float";
                            }
                            var astArg = new Ast(""+astName, [], [], astType);
							if (["GlobalVariable", "PlayerVariable", "Subroutine"].includes(astType)) {
								astArg.name = +astArg.name;
							}
                            astArg.parent = ast;
                            this.rebuildAst(astArg);
                            ast.args.push(astArg);

                        }
                    }
                },
                rebuildRuleAttributes: function(rule) {
                    if (rule.ruleAttributes.event === "global") {
                        delete rule.ruleAttributes.eventTeam;
                        delete rule.ruleAttributes.eventPlayer;
                        delete rule.ruleAttributes.subroutineName;
                    } else if (rule.ruleAttributes.event === "__subroutine__") {
                        delete rule.ruleAttributes.eventTeam;
                        delete rule.ruleAttributes.eventPlayer;
                        this.$set(rule.ruleAttributes, "subroutineName", this.subroutines[0].name);
                    } else {
                        delete rule.ruleAttributes.subroutineName;
                        if (!rule.ruleAttributes.eventTeam) {
                            this.$set(rule.ruleAttributes, "eventTeam", "all");
                        }
                        if (!rule.ruleAttributes.eventPlayer) {
                            this.$set(rule.ruleAttributes, "eventPlayer", "all");
                        }
                    }
                },
                selectAllRules: function() {
                    if (this.rules.every(x => x.isSelected)) {
                        for (var rule of this.rules) {
                            rule.isSelected = false;
                        }
                    } else {
                        for (var rule of this.rules) {
                            rule.isSelected = true;
                        }
                    }
                },
                selectAllConditions: function(rule) {
                    var unselectAll = rule.ruleAttributes.conditions.every(x => x.isSelected);
                    for (var condition of rule.ruleAttributes.conditions) {
                        condition.isSelected = !unselectAll;
                    }
                },
                selectAllActions: function(rule) {
                    var unselectAll = rule.children.every(x => x.isSelected);
                    for (var action of rule.children) {
                        action.isSelected = !unselectAll;
                    }
                },
                toggleSelectedRules: function() {
                    for (var rule of this.rules) {
                        if (rule.isSelected) {
                            rule.ruleAttributes.isDisabled = !rule.ruleAttributes.isDisabled;
                        }
                    }
                },
                toggleSelectedActions: function(rule) {
                    for (var action of rule.children) {
                        if (action.isSelected) {
                            action.isDisabled = !action.isDisabled;
                        }
                    }
                },
                toggleSelectedConditions: function(rule) {
                    for (var condition of rule.ruleAttributes.conditions) {
                        if (condition.isSelected) {
                            condition.isDisabled = !condition.isDisabled;
                        }
                    }
                },
                addAction: function(rule) {
                    var action = new Ast("__setGlobalVariable__", [new Ast(this.globalVariables[0].index+"", [], [], "GlobalVariable"), getAstFor0()]);
                    action.args[0].name = +action.args[0].name;
                    action.isSelected = false;
                    action.isDisabled = false;
                    action.parent = rule;
                    this.editActionOrCondition(action, false, null);
                },
                addCondition: function(rule) {
                    var condition = new Ast("__compare__", [getAstFor0(), new Ast("==", [], [], "__Operator__"), getAstFor0()]);
                    condition.isSelected = false;
                    condition.isDisabled = false;
                    condition.parent = rule;
                    this.editActionOrCondition(condition, true, null);
                },
                addRule: function() {
                    var rule = new Ast("__rule__");
                    rule.isSelected = false;
					rule.isCollapsed = false;
                    rule.ruleAttributes = {};
                    rule.ruleAttributes.conditions = [];
                    rule.ruleAttributes.event = "global";
                    rule.ruleAttributes.name = this.translate("rule", this.workshopUiKw, this.rules.length+1);
					rule.ruleAttributes.isDisabled = false;
                    this.rules.push(rule);
                },
                copySelectedRules: function() {
                    this.clipboard = {
                        type: "rules",
                        content: this.rules.filter(x => x.isSelected).map(x => structuredClone(x)),
                    }
                },
                copySelectedActions: function(rule) {
                    this.clipboard = {
                        type: "actions",
                        content: rule.children.filter(x => x.isSelected).map(x => structuredClone(x)),
                    }
                },
                copySelectedConditions: function(rule) {
                    this.clipboard = {
                        type: "conditions",
                        content: rule.ruleAttributes.conditions.filter(x => x.isSelected).map(x => structuredClone(x)),
                    }
                },
                pasteRules: function() {
                    var dataToPaste = this.clipboard.content.map(x => structuredClone(x));
                    for (var elem of dataToPaste) {
                        elem.isSelected = false;
                    }
                    this.rules.push(...dataToPaste);
                },
                pasteActions: function(rule) {
                    var dataToPaste = this.clipboard.content.map(x => structuredClone(x));
                    for (var elem of dataToPaste) {
                        elem.isSelected = false;
                        elem.parent = rule;
                    }
                    rule.children.push(...dataToPaste);
                },
                pasteConditions: function(rule) {
                    var dataToPaste = this.clipboard.content.map(x => structuredClone(x));
                    for (var elem of dataToPaste) {
                        elem.isSelected = false;
                        elem.parent = rule;
                    }
                    rule.ruleAttributes.conditions.push(...dataToPaste);
                },
                deleteSelectedActions: function(rule) {
                    this.displayDeleteConfirmationFor = "actions";
                    this.deleteForRule = rule;
                },
                deleteSelectedConditions: function(rule) {
                    this.displayDeleteConfirmationFor = "conditions";
                    this.deleteForRule = rule;
                },
                deleteSelectedRules: function() {
                    this.displayDeleteConfirmationFor = "rules";
                    this.deleteForRule = null;
                },
                cancelDeletion: function() {
                    this.displayDeleteConfirmationFor = null;
                    this.deleteForRule = null;
                },
                validateDeletion: function() {
                    if (this.displayDeleteConfirmationFor === "actions") {
                        this.deleteForRule.children = this.deleteForRule.children.filter(x => !x.isSelected);
                    } else if (this.displayDeleteConfirmationFor === "conditions") {
                        this.deleteForRule.ruleAttributes.conditions = this.deleteForRule.ruleAttributes.conditions.filter(x => !x.isSelected);
                    } else {
                        this.rules = this.rules.filter(x => !x.isSelected);
                    }
                    this.displayDeleteConfirmationFor = null;
                    this.deleteForRule = null;
                },
                moveSelected(array, moveUp) {
                    if (moveUp) {
                        for (var i = 1; i < array.length; i++) {
                            if (array[i].isSelected && !array[i-1].isSelected) {
                                var elem = array[i];
                                array.splice(i, 1);
                                array.splice(i-1, 0, elem);
                            }
                        }
                    } else {
                        for (var i = array.length - 2; i >= 0; i--) {
                            if (array[i].isSelected && !array[i+1].isSelected) {
                                var elem = array[i];
                                array.splice(i, 1);
                                array.splice(i+1, 0, elem);
                            }
                        }
                    }
                },
                moveSelectedActions(rule, moveUp) {
                    this.moveSelected(rule.children, moveUp);
                },
                moveSelectedConditions(rule, moveUp) {
                    this.moveSelected(rule.ruleAttributes.conditions, moveUp);
                },
                moveSelectedRules(moveUp) {
                    this.moveSelected(this.rules, moveUp);
                },
                moveArrayElement(array, i, moveUp) {
                    if (moveUp && i > 0) {
                        var elem = array.args[i];
                        array.args.splice(i, 1);
                        array.args.splice(i-1, 0, elem);
                    } else if (!moveUp && i < array.args.length - 1) {
                        var elem = array.args[i];
                        array.args.splice(i, 1);
                        array.args.splice(i+1, 0, elem);
                    }
                },
                removeFromArray(array, i) {
                    array.args.splice(i, 1);
                },
                addToArray(array) {
                    arg = new Ast("null");
                    arg.parent = array;
                    array.args.push(arg);
                },
                validateVariableOrSubroutineName: function(index, name, type) {
                    if (!name) {
                        throw new Error(this.translate("empty"+type+"Name", this.workshopUiKw, index))
                    }
                    if (name.length > 32) {
                        throw new Error(this.translate("tooLong"+type+"Name", this.workshopUiKw, index))
                    }
                    if (!name.match(/^[A-Za-z_][A-Za-z0-9_]{0,31}$/)) {
                        throw new Error(this.translate("invalid"+type+"Name", this.workshopUiKw, index))
                    }
                },
                editVariables: function() {
                    this.displayVariableEditor = true;
                    this.editedGlobalVariables = structuredClone(this.globalVariables);
                    this.editedPlayerVariables = structuredClone(this.playerVariables);
                },
                editSubroutines: function() {
                    this.displaySubroutineEditor = true;
                    this.editedSubroutines = structuredClone(this.subroutines);
                },
                cancelVarEdition: function() {
                    this.displayVariableEditor = false;
                },
                cancelSubroutineEdition: function() {
                    this.displaySubroutineEditor = false;
                },
                validateVariables: function() {
                    for (var v of this.editedGlobalVariables) {
                        v.name = v.name.trim();
                        this.validateVariableOrSubroutineName(v.index, v.name, "GlobalVar");
                        if (this.editedGlobalVariables.filter(x => x.name === v.name).length > 1) {
                            throw new Error(this.translate("conflictingGlobalVarName", this.workshopUiKw, v.index))
                        }
                    }
                    for (var v of this.editedPlayerVariables) {
                        v.name = v.name.trim();
                        this.validateVariableOrSubroutineName(v.index, v.name, "PlayerVar");
                        if (this.editedPlayerVariables.filter(x => x.name === v.name).length > 1) {
                            throw new Error(this.translate("conflictingPlayerVarName", this.workshopUiKw, v.index))
                        }
                    }
                    this.globalVariables = structuredClone(this.editedGlobalVariables);
                    this.playerVariables = structuredClone(this.editedPlayerVariables);
                    this.displayVariableEditor = false;
                },
                validateSubroutines: function() {
                    for (var v of this.editedSubroutines) {
                        v.name = v.name.trim();
                        this.validateVariableOrSubroutineName(v.index, v.name, "Subroutine");
                        if (this.editedSubroutines.filter(x => x.name === v.name).length > 1) {
                            throw new Error(this.translate("conflictingSubroutineName", this.workshopUiKw, v.index))
                        }
                    }
                    this.subroutines = structuredClone(this.editedSubroutines);
                    this.displaySubroutineEditor = false;
                },
                resetVariablesToDefault: function() {
                    for (var i = 0; i < this.editedGlobalVariables.length; i++) {
                        this.editedGlobalVariables[i].name = defaultVarNames[i];
                        this.editedPlayerVariables[i].name = defaultVarNames[i];
                    }
                },
                resetSubroutinesToDefault: function() {
                    for (var i = 0; i < this.editedSubroutines.length; i++) {
                        this.editedSubroutines[i].name = defaultSubroutineNames[i];
                    }
                },
                editExtensions: function() {
                    this.compileGamemode();
                    this.editedActivatedExtensions = structuredClone(this.activatedExtensions);
                    this.availableExtensionPoints = availableExtensionPoints;
                    this.displayExtensionsEditor = true;
                },
                getSpentExtensionPoints: function() {
                    return [...this.editedActivatedExtensions].map(x => this.customGameSettingsSchema.extensions.values[x].points).reduce((partialSum, x) => partialSum+x, 0)
                },
                cancelExtensionEdition: function() {
                    this.displayExtensionsEditor = false;
                },
                validateExtensions: function() {
                    if (this.getSpentExtensionPoints() > this.availableExtensionPoints) {
                        throw new Error(this.translate("notEnoughExtensionPoints", this.workshopUiKw));
                    }
                    this.activatedExtensions = structuredClone(this.editedActivatedExtensions);
                    this.displayExtensionsEditor = false;
                },
                resetExtensionsToDefault: function() {
                    this.editedActivatedExtensions = [];
                },
                displayMetricsScreen: function() {
                    this.compileGamemode();
                    this.nbElements = nbElements;
                    this.displayMetrics = true;
                },
                calculateDropdownPosition: function(dropdownList, component, {width}) {
                    dropdownList.style.width = width;
                    const popper = Popper.createPopper(component.$refs.toggle, dropdownList, {
                    placement: "bottom",
                    modifiers: [
                        {
                        name: 'offset',
                        options: {
                            offset: [0, -1],
                        },
                        },
                        {
                        name: 'toggleClass',
                        enabled: true,
                        phase: 'write',
                        fn({ state }) {
                            component.$el.classList.toggle(
                            'drop-up',
                            state.placement === 'top'
                            )
                        },
                        },
                    ],
                    })
                    return () => popper.destroy()
                },
                updateTextareaHeight: function(textarea) {
                    textarea.style.height = '';
                    textarea.style.height = textarea.scrollHeight +'px'
                },
				editCustomGameSettings: function() {
					var editedCustomGameSettings = structuredClone(this.customGameSettings);
					
					function fillMissingKeys(settings, schema) {
						for (var key of Object.keys(schema)) {
							if (key === "extensions" || key === "workshop") {
								continue;
							}
							if (!(key in settings)) {
								console.log("Adding key '"+key+"'");
								if (schema[key].values === "__boolOnOff__") {
									if (schema[key].default === "on") {
										settings[key] = true;
									} else if (schema[key].default === "off") {
										settings[key] = false;
									} else {
										throw new Error("no default for '"+key+"'");
									}
								} else if (schema[key].values === "__boolYesNo__") {
									if (schema[key].default === "yes") {
										settings[key] = true;
									} else if (schema[key].default === "no") {
										settings[key] = false;
									} else {
										throw new Error("no default for '"+key+"'");
									}
								} else if (schema[key].values === "__boolEnabled__") {
									if (schema[key].default === "enabled") {
										settings[key] = true;
									} else if (schema[key].default === "disabled") {
										settings[key] = false;
									} else {
										throw new Error("no default for '"+key+"'");
									}
								} else if (schema[key].values === "__boolReverseOnOff__") {
									if (schema[key].default === "on") {
										settings[key] = false;
									} else if (schema[key].default === "off") {
										settings[key] = true;
									} else {
										throw new Error("no default for '"+key+"'");
									}
								} else if (schema[key].values === "__percent__") {
									settings[key] = schema[key].default;
								} else if (schema[key].values === "__int__") {
									settings[key] = schema[key].default;
								} else if (schema[key].values === "__float__") {
									settings[key] = schema[key].default;
								} else if (schema[key].values === "__percent__") {
									settings[key] = schema[key].default;
								} else if (schema[key].values === "__string__") {
									settings[key] = "";
								} else if (typeof schema[key].values === "object") {
									var defaultSetting = Object.keys(schema[key].values).filter(x => schema[key].values[x].default === true);
									if (defaultSetting.length !== 1) {
										throw new Error("Could not find default setting for '"+key+"'");
									}
									settings[key] = defaultSetting[0];
								}
							}
						}
					}

					if (!editedCustomGameSettings.lobby) {
						editedCustomGameSettings.lobby = {};
					}
					fillMissingKeys(editedCustomGameSettings.lobby, customGameSettingsSchema.lobby.values);
					if (!editedCustomGameSettings.main) {
						editedCustomGameSettings.main = {};
					}
					fillMissingKeys(editedCustomGameSettings.main, customGameSettingsSchema.main.values);
					if (!editedCustomGameSettings.gamemodes) {
						editedCustomGameSettings.gamemodes = {};
					}
					for (var gamemode in customGameSettingsSchema.gamemodes.values) {
						if (gamemode in gamemodeKw && gamemodeKw[gamemode].onlyInOw1) {
							delete editedCustomGameSettings.gamemodes[gamemode];
							continue;
						}
						if (!(gamemode in editedCustomGameSettings.gamemodes)) {
							editedCustomGameSettings.gamemodes[gamemode] = {enabled: false};
						} else {
							editedCustomGameSettings.gamemodes[gamemode].enabled = true;
						}
						if ("disabledMaps" in editedCustomGameSettings.gamemodes[gamemode]) {
							editedCustomGameSettings.gamemodes.enabledMaps = Object.keys(mapKw).filter(x => mapKw[x].gamemodes.includes(gamemode) && !mapKw[x].onlyInOw1 && !editedCustomGameSettings.gamemodes.disabledMaps.includes(x));
							delete editedCustomGameSettings.gamemodes.disabledMaps;
						}
						fillMissingKeys(editedCustomGameSettings.gamemodes[gamemode], customGameSettingsSchema.gamemodes.values[gamemode].values);
						editedCustomGameSettings.gamemodes[gamemode].isCollapsed = true;
						editedCustomGameSettings.gamemodes[gamemode].isArrayCollapsed = true;
					}
					if (!editedCustomGameSettings.heroes) {
						editedCustomGameSettings.heroes = {};
					}
					for (var team in customGameSettingsSchema.heroes.teams) {
						if (!(team in editedCustomGameSettings.heroes)) {
							editedCustomGameSettings.heroes[team] = {};
						}
						editedCustomGameSettings.heroes[team].isCollapsed = true;
						editedCustomGameSettings.heroes[team].isArrayCollapsed = true;
						if ("disabledHeroes" in editedCustomGameSettings.heroes[team]) {
							editedCustomGameSettings.heroes[team].enabledHeroes = Object.keys(heroKw).filter(x => !editedCustomGameSettings.heroes[team].disabledHeroes.includes(x));
							delete editedCustomGameSettings.heroes[team].disabledHeroes
						} else if (!("enabledHeroes" in editedCustomGameSettings.heroes[team])) {
							editedCustomGameSettings.heroes[team].enabledHeroes = Object.keys(heroKw);
						}
						for (var hero in customGameSettingsSchema.heroes.values) {
							if (hero === "disabledHeroes" || hero === "enabledHeroes") {
								continue;
							}
							console.log(hero);
							if (!(hero in editedCustomGameSettings.heroes[team])) {
								editedCustomGameSettings.heroes[team][hero] = {};
							}
							fillMissingKeys(editedCustomGameSettings.heroes[team][hero], customGameSettingsSchema.heroes.values[hero].values);
							editedCustomGameSettings.heroes[team][hero].isCollapsed = true;
						}
					}

					for (var key in editedCustomGameSettings) {
						editedCustomGameSettings[key].isCollapsed = true;
					}

					this.editedCustomGameSettings = editedCustomGameSettings;
					this.displaySettings = true;
				},

				validateSettings: function() {

					function removeDefaults(settings, schema) {
						for (var key in settings) {
							if (key === "enabled") {
								continue;
							}
							if (!(key in schema)) {
								throw new Error(key+" not found in schema");
							}
							var defaultSetting = schema[key].default;
							if (schema[key].values === "__boolReverseOnOff__") {
								defaultSetting = (defaultSetting === "on" ? false : true);
							} else if (["yes", "enabled", "on"].includes(defaultSetting)) {
								defaultSetting = true;
							} else if (["no", "disabled", "off"].includes(defaultSetting)) {
								defaultSetting = false;
							}
							if (settings[key] === defaultSetting) {
								delete settings[key];
							}
						}
					}
					
					for (var key in this.editedCustomGameSettings) {
						delete this.editedCustomGameSettings[key].isCollapsed;
					}
					removeDefaults(this.editedCustomGameSettings.lobby, customGameSettingsSchema.lobby.values)
					removeDefaults(this.editedCustomGameSettings.main, customGameSettingsSchema.main.values)
					for (var key in this.editedCustomGameSettings.gamemodes) {
						delete this.editedCustomGameSettings.gamemodes[key].isCollapsed;
						delete this.editedCustomGameSettings.gamemodes[key].isArrayCollapsed;
						removeDefaults(this.editedCustomGameSettings.gamemodes[key], customGameSettingsSchema.gamemodes.values[key].values)
					}
					for (var team in this.editedCustomGameSettings.heroes) {
						delete this.editedCustomGameSettings.heroes[team].isCollapsed;
						delete this.editedCustomGameSettings.heroes[team].isArrayCollapsed;
						for (var hero in this.editedCustomGameSettings.heroes[team]) {

							delete this.editedCustomGameSettings.heroes[team][hero].isCollapsed;
							delete this.editedCustomGameSettings.heroes[team][hero].isArrayCollapsed;
							if (hero !== "enabledHeroes") {	
								console.log(hero);
								removeDefaults(this.editedCustomGameSettings.heroes[team][hero], customGameSettingsSchema.heroes.values[hero].values)
							}
						}
					}

					this.customGameSettings = structuredClone(this.editedCustomGameSettings);
					this.displaySettings = false;
					this.saveGamemode();
				}

            },
        })

        console.info = app.info;
        console.warn = app.warn;
        console.error = app.error;



        /*app.decompile(`


`);*/
    </script>
</body>
</html>
